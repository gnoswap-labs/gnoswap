# GnoSwap 아키텍처

## 개요

GnoSwap은 **무중단 업그레이드**, **독립적인 컨트랙트 버전 관리**, **데이터 마이그레이션 없는 중앙 집중식 데이터 관리**를 가능하게 하는 **프록시 패턴 아키텍처**로 구성됩니다.

## 아키텍처 패턴

```
┌─────────────────────────────────────────────────────────────┐
│  프록시 레이어: 공개 인터페이스                              │
│  - proxy.gno: 현재 구현체로 호출 라우팅                     │
│  - upgrade.gno: 구현체 업그레이드 관리                      │
│  - types.gno: IPool 인터페이스 계약 정의                    │
└─────────────────────────────────────────────────────────────┘
                          ▲
                          │ 위임
                          │
┌─────────────────────────────────────────────────────────────┐
│  구현 레이어: 버전별 비즈니스 로직                          │
│  - v1/: 풀 구현체 v1                                        │
│  - v2/: 풀 구현체 v2 (미래)                                 │
│  - 각 버전은 IPool 인터페이스 구현                          │
└─────────────────────────────────────────────────────────────┘
                          ▲
                          │ 사용
                          │
┌─────────────────────────────────────────────────────────────┐
│  스토리지 레이어: 중앙 집중식 데이터 관리                    │
│  - store.gno: 도메인별 스토리지 접근                        │
│  - state.gno: 전역 상태 관리                                │
│  - p/gnoswap/store: 핵심 KV 스토리지 인프라                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 프록시 레이어: 공개 인터페이스

### 목적

현재 구현체 버전으로 호출을 라우팅하는 안정적인 공개 인터페이스를 제공합니다.

### 구성 요소

| 구성 요소       | 역할            | 주요 특징                        |
| --------------- | --------------- | -------------------------------- |
| **proxy.gno**   | 공개 API 라우팅 | 모든 호출을 현재 구현체로 라우팅 |
| **upgrade.gno** | 구현체 관리     | 구현체 등록 및 업그레이드 관리   |
| **types.gno**   | 인터페이스 정의 | IPool 컨트랙트 인터페이스 정의   |
| **state.gno**   | 전역 상태 관리  | 구현체 및 초기화자 관리          |

### 주요 특징

- **안정적인 인터페이스** - 공개 API는 절대 변경되지 않음
- **동적 라우팅** - 호출이 현재 구현체로 라우팅됨
- **업그레이드 관리** - 원활한 구현체 전환
- **인터페이스 계약** - 구현체 호환성 강제

### 디렉토리 구조

```
pool/
├── proxy.gno                    # 공개 API 함수들
├── upgrade.gno                  # 구현체 관리
├── types.gno                    # IPool 인터페이스 정의
├── state.gno                    # 전역 상태 관리
└── store.gno                    # 도메인 스토리지 접근
```

---

## 구현 레이어: 버전별 비즈니스 로직

### 목적

인터페이스 준수를 통한 독립적인 업그레이드 기능을 가진 버전별 비즈니스 로직을 구현합니다.

### 풀 구현체 구조

```
pool/
├── v1/                          # 풀 구현체 v1
│   ├── init.gno                # v1 구현체 등록
│   ├── manager.gno             # 풀 관리 함수들
│   ├── position.gno            # 포지션 관리 (스텁)
│   ├── swap.gno                # 스왑 함수들 (스텁)
│   ├── getter.gno              # 조회 함수들 (스텁)
│   ├── errors.gno              # 에러 정의들
│   ├── assert.gno              # 어설션 함수들
│   ├── factory_param.gno       # 팩토리 매개변수
│   ├── pool_type.gno           # 풀 타입 정의들
│   ├── utils.gno               # 유틸리티 함수들
│   └── gnomod.toml             # 모듈 설정
│
└── v2/                          # 풀 구현체 v2 (미래)
    └── ...                      # 향상된 기능들
```

### 인터페이스 준수

각 구현체는 `IPool` 인터페이스를 구현해야 합니다:

```go
type IPool interface {
    IPoolManager    // 풀 생성 및 관리
    IPoolPosition   // 포지션 작업 (Mint, Burn, Collect)
    IPoolSwap       // 스왑 작업 및 프로토콜 수수료
    IPoolGetter     // 데이터 조회 함수들
}
```

### 주요 특징

- **인터페이스 준수** - 모든 버전이 IPool 인터페이스 구현
- **독립적 개발** - 각 버전이 별도로 개발됨
- **하위 호환성** - 인터페이스가 호환성 보장
- **등록 시스템** - 초기화자를 통한 구현체 등록

---

## 스토리지 레이어: 중앙 집중식 데이터 관리

### 목적

도메인별 접근 패턴을 가진 중앙 집중식 데이터 스토리지를 제공합니다.

### 구성 요소

| 구성 요소           | 역할                    | 주요 특징                   |
| ------------------- | ----------------------- | --------------------------- |
| **store.gno**       | 도메인 스토리지 접근    | 풀별 스토리지 작업          |
| **p/gnoswap/store** | 핵심 KV 스토리지 인프라 | 타입 무관 키-값 스토리지    |
| **access**          | 접근 제어               | 역할 기반 권한 부여         |
| **rbac**            | 역할 관리               | 역할 등록 및 업데이트       |
| **halt**            | 긴급 중단               | 도메인별 긴급 정지 메커니즘 |

### 주요 특징

- **중앙 집중식 스토리지** - 모든 버전을 위한 단일 스토리지 시스템
- **네임스페이스 격리** - 도메인별 스토리지 네임스페이스
- **접근 제어** - 역할 기반 스토리지 권한
- **데이터 마이그레이션 불필요** - 모든 버전이 동일한 데이터 공유

### 디렉토리 구조

```
# 불변 컨트랙트 (절대 업그레이드되지 않음)
p/gnoswap/store/                 # 핵심 스토리지 인프라
├── kv_store.gno                 # 범용 키-값 저장소
└── types.gno                    # 스토리지 타입들

r/gnoswap/access/                # 접근 제어 시스템
├── access.gno                   # 접근 어설션
├── assert.gno                   # 접근 검증
└── swap_whitelist.gno           # 스왑 화이트리스트 관리

r/gnoswap/rbac/                  # 역할 기반 접근 제어
├── rbac.gno                     # 역할 관리
├── role.gno                     # 역할 정의들
└── types.gno                    # RBAC 타입들

r/gnoswap/halt/                  # 긴급 중단 시스템
├── halt.gno                     # 중단 관리
├── config.gno                   # 중단 설정
└── types.gno                    # 중단 타입들

# 업그레이드 관리 컨트랙트 (업그레이드 관리)
r/gnoswap/pool/                  # 풀 도메인 관리
├── proxy.gno                    # 공개 API 라우팅
├── upgrade.gno                  # 구현체 관리
├── types.gno                    # IPool 인터페이스 정의
├── state.gno                    # 전역 상태 관리
├── store.gno                    # 도메인 스토리지 접근
└── v1/                          # 풀 구현체 v1

r/gnoswap/position/              # 포지션 도메인 관리
├── proxy.gno                    # 공개 API 라우팅
├── upgrade.gno                  # 구현체 관리
├── types.gno                    # IPosition 인터페이스 정의
├── state.gno                    # 전역 상태 관리
├── store.gno                    # 도메인 스토리지 접근
└── v1/                          # 포지션 구현체 v1

r/gnoswap/router/                # 라우터 도메인 관리
├── proxy.gno                    # 공개 API 라우팅
├── upgrade.gno                  # 구현체 관리
├── types.gno                    # IRouter 인터페이스 정의
├── state.gno                    # 전역 상태 관리
├── store.gno                    # 도메인 스토리지 접근
└── v1/                          # 라우터 구현체 v1

r/gnoswap/staker/                # 스테이커 도메인 관리
├── proxy.gno                    # 공개 API 라우팅
├── upgrade.gno                  # 구현체 관리
├── types.gno                    # IStaker 인터페이스 정의
├── state.gno                    # 전역 상태 관리
├── store.gno                    # 도메인 스토리지 접근
└── v1/                          # 스테이커 구현체 v1

...

# 버전별 컨트랙트 (업그레이드 가능한 비즈니스 로직)
r/gnoswap/pool/v1/               # 풀 v1 구현체
r/gnoswap/position/v1/           # 포지션 v1 구현체
r/gnoswap/router/v1/             # 라우터 v1 구현체
r/gnoswap/staker/v1/             # 스테이커 v1 구현체
...
```

---

## 컨트랙트 분류

### 1. 불변 컨트랙트 (절대 업그레이드되지 않음)

이 컨트랙트들은 핵심 인프라를 구성하며 배포 후 절대 수정되지 않습니다:

- **`p/gnoswap/store`**: 타입 무관 키-값 스토리지를 제공하는 핵심 스토리지 인프라
- **`r/gnoswap/access`**: 역할 기반 권한을 관리하는 접근 제어 시스템
- **`r/gnoswap/rbac`**: 역할 주소를 관리하는 역할 기반 접근 제어
- **`r/gnoswap/halt`**: 프로토콜 안전을 위한 긴급 중단 시스템

**특징:**

- 한 번 배포되고 절대 수정되지 않음
- 모든 다른 컨트랙트에 대한 기반 서비스 제공
- 시스템 보안과 안정성에 중요

### 2. 업그레이드 관리 컨트랙트 (업그레이드 관리)

이 컨트랙트들은 업그레이드 프로세스를 관리하고 버전 간 조정을 담당합니다:

- **`r/gnoswap/pool`**: 프록시 패턴을 사용한 풀 도메인 관리
- **`r/gnoswap/position`**: 프록시 패턴을 사용한 포지션 도메인 관리
- **`r/gnoswap/router`**: 프록시 패턴을 사용한 라우터 도메인 관리
- **`r/gnoswap/staker`**: 프록시 패턴을 사용한 스테이커 도메인 관리
- 기타 도메인 컨트랙트들...

**특징:**

- 버전별 컨트랙트의 업그레이드 프로세스 관리
- 서로 다른 컨트랙트 버전 간 조정
- 자주 변경되지 않는 도메인별 비즈니스 로직 처리

### 3. 버전별 컨트랙트 (업그레이드 가능한 비즈니스 로직)

이 컨트랙트들은 실제 비즈니스 로직을 구현하며 업그레이드가 가능합니다:

- **`r/gnoswap/pool/v1`**: 풀 구현체 v1
- **`r/gnoswap/position/v1`**: 포지션 관리 v1
- **`r/gnoswap/router/v1`**: 스왑 라우팅 v1
- **`r/gnoswap/staker/v1`**: 스테이킹 및 보상 v1
- 기타 버전별 컨트랙트들...

**특징:**

- 특정 비즈니스 로직 구현
- 새 버전(v2, v3 등)으로 업그레이드 가능
- 호환성을 위해 정의된 인터페이스 구현 필요
- 중앙 집중식 스토리지를 통해 데이터 공유

---

## 데이터 흐름

### 완전한 예시: 풀 스왑 작업

```
사용자 요청
     │
     ▼
┌─────────────────────────────────────────┐
│ 프록시 레이어: pool/proxy.gno            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 1. getImpl() → 현재 구현체 반환         │
│ 2. 구현체에 위임                        │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 구현체: pool/v1/swap.gno                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 1. halt.AssertIsNotHaltedPool()         │
│ 2. access.AssertIsAuthorized()          │
│ 3. 비즈니스 로직 실행                   │
│ 4. store.Get/Set 작업                   │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 스토리지 레이어: pool/store.gno          │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 1. 도메인 키로 kvStore.Get/Set          │
│ 2. 타입 변환 및 검증                    │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 핵심 스토리지: p/gnoswap/store/kv_store.gno │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 1. 도메인 권한 확인                      │
│ 2. map[key]value 저장                    │
│ 3. 타입 무관 (any 타입)                  │
└─────────────────────────────────────────┘
```

---

## 핵심 설계 원칙

### 1. 명확한 관심사 분리

```
프록시 레이어: "구현체로 호출을 어떻게 라우팅할까?"
구현 레이어: "어떤 비즈니스 규칙을 적용할까?"
스토리지 레이어: "어디에 저장하고 어떻게 접근할까?"
```

### 2. 인터페이스 기반 설계

```
모든 구현체는 IPool 인터페이스를 구현해야 함
프록시가 현재 구현체로 호출 라우팅
인터페이스가 하위 호환성 보장
```

### 3. 버전 독립성

```
pool/v1, pool/v2 → 동일한 pool/store 사용
pool/v2 배포가 pool/v1에 영향을 주지 않음
중앙 집중식 스토리지를 통한 데이터 공유
```

### 4. 중앙 집중식 스토리지

```
모든 버전을 위한 단일 스토리지 시스템
네임스페이스 기반 격리
데이터 마이그레이션 불필요
```

---

## 업그레이드 프로세스

### 예시: 풀을 v1에서 v2로 업그레이드

```
┌─────────────────────────────────────────┐
│ 단계 1: pool/v2 배포                    │
│ - 향상된 기능의 새 컨트랙트             │
│ - IPool 인터페이스 구현                 │
│ - RegisterInitializer()로 등록          │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 단계 2: pool/upgrade.gno 호출           │
│ - UpgradeImpl("pool/v2")                │
│ - 구현체 포인터 전환                    │
│ - 스토리지 권한 업데이트                │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 결과:                                   │
│ - pool/v1 여전히 등록됨                 │
│ - pool/v2 현재 활성화                   │
│ - 데이터 마이그레이션 불필요            │
│ - 무중단                                │
│ - v1은 롤백 기능을 위해 유지됨          │
└─────────────────────────────────────────┘
```

---

## 이점

### 1. 무중단 업그레이드

- 구버전과 신버전이 공존
- 즉시 구현체 전환
- 즉시 롤백 가능
- 이전 버전들이 긴급 롤백을 위해 등록 상태 유지

### 2. 데이터 마이그레이션 불필요

- 단일 중앙 집중식 스토리지
- 모든 버전이 동일한 데이터 공유
- 인터페이스가 호환성 보장

### 3. 독립적인 컨트랙트 업그레이드

- 다른 도메인에 영향을 주지 않고 풀 업그레이드 가능
- 인터페이스 검증으로 호환성 보장
- 초기화자를 통한 버전 관리

### 4. 강력한 접근 제어

- 네임스페이스 기반 격리
- 역할 기반 권한 부여
- 도메인별 중단 메커니즘

### 5. 간소화된 테스트

- 각 레이어 독립적으로 테스트
- 명확한 경계와 인터페이스
- 의존성 모킹 용이

---

## 보안 고려사항

### 1. 인터페이스 준수

- 모든 구현체는 IPool 인터페이스를 구현해야 함
- 인터페이스가 호환성 파괴 변경 방지
- 컴파일 타임 호환성 검사

### 2. 접근 제어

- 역할 기반 스토리지 권한
- 네임스페이스 격리
- 관리자 전용 업그레이드 함수

### 3. 긴급 중단

- 도메인별 중단 기능
- 독립적인 중단 상태
- 특정 구현체만 중단 가능

### 4. 불변 인프라

- 핵심 스토리지는 업그레이드 불가
- 인터페이스 계약이 안정적
- 예측 가능한 시스템 동작

---

## 구현 세부사항

### 등록 프로세스

```go
// pool/v1/init.gno에서
func init() {
    pool.RegisterInitializer(cross, func(poolStore pool.IPoolStore) pool.IPool {
        return NewPoolV1(poolStore)
    })
}
```

### 업그레이드 프로세스

```go
// pool/upgrade.gno에서
func UpgradeImpl(cur realm, packagePath string) {
    caller := runtime.PreviousRealm().Address()
    access.AssertIsAdmin(caller)

    if _, ok := initializers[packagePath]; !ok {
        panic("Initializer not found")
    }

    poolImpl = initializers[packagePath](NewPoolStore(kvStore))
    // 스토리지 권한 업데이트...
}
```

### 프록시 라우팅

```go
// pool/proxy.gno에서
func CreatePool(cur realm, token0Path, token1Path string, fee uint32, sqrtPriceX96 string) {
    getImpl().CreatePool(token0Path, token1Path, fee, sqrtPriceX96)
}

func getImpl() IPool {
    if poolImpl == nil {
        panic("pool implementation is not set")
    }
    return poolImpl
}
```

이 프록시 패턴 아키텍처는 데이터 일관성을 유지하면서 원활한 기능 진화를 가능하게 하는 견고하고 업그레이드 가능한 GnoSwap의 기반을 제공합니다.
