# GnoSwap 아키텍처

## 개요

GnoSwap은 **무중단 업그레이드**, **독립적인 컨트랙트 버전 관리**, **데이터 마이그레이션 없는 중앙 집중식 데이터 관리**를 가능하게 하는 **3Layer 아키텍처**로 구성됩니다.

## 아키텍처 Layer

```
┌─────────────────────────────────────────────────────────────┐
│  Layer 2: 버전별 비즈니스 로직                               │
│  독립적인 컨트랙트 버전 (v1, v2, v3...)                     │
└─────────────────────────────────────────────────────────────┘
                          ▲
                          │ 사용
                          │
┌─────────────────────────────────────────────────────────────┐
│  Layer 1: 도메인 스토리지 & 핵심 서비스                      │
│  도메인별 스토리지 접근 + 핵심 서비스                       │
└─────────────────────────────────────────────────────────────┘
                          ▲
                          │ 사용
                          │
┌─────────────────────────────────────────────────────────────┐
│  Layer 0: 시스템 인프라                                      │
│  핵심 인프라 + 순수 KV 스토리지                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Layer 0: 시스템 인프라

### 목적

불변의 핵심 인프라와 순수 키-값 스토리지를 제공합니다.

### 구성 요소

| 구성 요소      | 역할             | 특징                                   |
| -------------- | ---------------- | -------------------------------------- |
| **storage**    | 순수 KV 스토리지 | 타입 무관, 네임스페이스 기반 접근 제어 |
| **access**     | 접근 제어        | 역할 → 주소 매핑 관리                  |
| **rbac**       | 역할 관리        | 역할 등록/업데이트, 버전 관리          |
| **halt**       | 긴급 중단        | 버전별 긴급 정지 메커니즘              |
| **dependency** | 의존성 관리      | 컨트랙트 의존성 추적 및 검증           |

### 주요 특징

- **불변** - 배포 후 업그레이드 없음
- **범용** - 도메인 지식 불필요
- **인프라 전용** - 모든 상위 Layer의 기반

### 디렉토리 구조

```
sys/
├── storage/                   # 순수 KV 스토리지
│   ├── kv_store.gno           # 범용 키-값 저장소
│   ├── namespace.gno          # 네임스페이스 상수
│   ├── authorization.gno      # 네임스페이스 접근 제어
│   └── doc.gno
│
├── access/                    # 접근 제어
│   ├── registry.gno           # 역할 → 주소 매핑
│   ├── assertions.gno         # 접근 단언
│   ├── getters.gno            # 역할 주소 조회
│   └── doc.gno
│
├── rbac/                      # 역할 기반 접근 제어
│   ├── rbac.gno               # 역할 관리
│   ├── roles.gno              # 역할 상수
│   ├── events.gno             # RBAC 이벤트
│   └── doc.gno
│
├── halt/                      # 긴급 중단
│   ├── halt.gno               # 중단 상태 관리
│   ├── assertions.gno         # 중단 확인
│   ├── config.gno             # 중단 설정
│   └── doc.gno
│
└── dependency/                # 의존성 관리자
    ├── registry.gno           # 의존성 등록
    ├── resolver.gno           # 의존성 해결
    └── doc.gno
```

---

## Layer 1: 도메인 스토리지 & 핵심 서비스

### 목적

도메인별 스토리지 접근 인터페이스와 불변의 핵심 서비스를 제공합니다.

### 구성 요소

| 도메인             | 역할                                       | 핵심 파일                    |
| ------------------ | ------------------------------------------ | ---------------------------- |
| **gns**            | GNS 토큰 컨트랙트                          | `token.gno`                  |
| **xgns**           | xGNS 토큰 컨트랙트                         | `token.gno`                  |
| **gnft**           | Gnoswap NFT 컨트랙트                       | `token.gno`                  |
| **emission**       | 배출 서비스 + 중앙 스토리지 접근           | `storage.gno`                |
| **referral**       | 추천 서비스 + 중앙 스토리지 접근           | `storage.gno`                |
| **common**         | 공통 유틸리티 + 스토리지 접근 + 업그레이드 | `storage.gno`, `upgrade.gno` |
| **pool**           | 풀 스토리지 접근 + 업그레이드              | `storage.gno`, `upgrade.gno` |
| **position**       | 포지션 스토리지 접근 + 업그레이드          | `storage.gno`, `upgrade.gno` |
| **router**         | 라우터 스토리지 접근 + 업그레이드          | `storage.gno`, `upgrade.gno` |
| **staker**         | 스테이커 스토리지 접근 + 업그레이드        | `storage.gno`, `upgrade.gno` |
| **gov/governance** | 거버넌스 스토리지 접근 + 업그레이드        | `storage.gno`, `upgrade.gno` |
| **gov/staker**     | Gov 스테이커 스토리지 접근 + 업그레이드    | `storage.gno`, `upgrade.gno` |
| **launchpad**      | 런치패드 스토리지 접근 + 업그레이드        | `storage.gno`, `upgrade.gno` |
| **protocol_fee**   | 프로토콜 수수료 스토리지 접근 + 업그레이드 | `storage.gno`, `upgrade.gno` |
| **community_pool** | 커뮤니티 풀 스토리지 접근 + 업그레이드     | `storage.gno`, `upgrade.gno` |

### 주요 특징

- **불변** - 배포 후 수정 없음
- **네임스페이스 기반 스토리지** - 각 도메인은 격리된 스토리지 네임스페이스를 가짐
- **업그레이드 함수** - 컨트랙트 버전 전환 관리
- **확장 가능** - 새로운 도메인 추가 가능

### 디렉토리 구조

```
r/
├── gns/                           # GNS 토큰
├── xgns/                          # xGNS 토큰
├── gnft/                          # Gnoswap NFT
│
├── emission/                      # 배출 서비스
│   └── storage.gno                # 중앙 스토리지 접근
│
├── referral/                      # 추천 서비스
│   └── storage.gno                # 중앙 스토리지 접근
│
├── common/                        # 공통 유틸리티
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── pool/                          # 풀 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── position/                      # 포지션 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── router/                        # 라우터 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── staker/                        # 스테이커 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── gov/
│   ├── governance/                # 거버넌스 도메인
│   │   ├── upgrade.gno            # 컨트랙트 업그레이드/다운그레이드
│   │   └── storage.gno            # 중앙 스토리지 접근
│   │
│   └── staker/                    # Gov 스테이커 도메인
│       ├── upgrade.gno            # 컨트랙트 업그레이드/다운그레이드
│       └── storage.gno            # 중앙 스토리지 접근
│
├── launchpad/                     # 런치패드 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
├── protocol_fee/                  # 프로토콜 수수료 도메인
│   ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
│   └── storage.gno                # 중앙 스토리지 접근
│
└── community_pool/                # 커뮤니티 풀 도메인
    ├── upgrade.gno                # 컨트랙트 업그레이드/다운그레이드
    └── storage.gno                # 중앙 스토리지 접근
```

---

## Layer 2: 버전별 비즈니스 로직

### 목적

독립적인 업그레이드 기능을 가진 버전별 비즈니스 로직을 구현합니다.

### 공통 구조

각 도메인 컨트랙트는 다음 구조를 따릅니다:

```
{domain}/
├── v1/
│   ├── accessor.gno           # 도메인 스토리지에 대한 스토리지 접근자
│   ├── register.gno           # 의존성 등록
│   └── ...                    # 비즈니스 로직 파일
│
└── v2/
    ├── accessor.gno           # 도메인 스토리지에 대한 스토리지 접근자
    ├── register.gno           # 의존성 등록
    └── ...                    # 비즈니스 로직 파일 + 새로운 기능
```

### 도메인

| 도메인             | v1 기능                                                         |
| ------------------ | --------------------------------------------------------------- |
| **common**         | 기본 유틸리티                                                   |
| **pool**           | 스왑, 유동성, 수수료                                            |
| **position**       | 포지션 생성, 포지션 제거, 유동성 증가, 유동성 감소, 수수료 수령 |
| **router**         | Exact In/Out, 멀티홉                                            |
| **staker**         | 스테이크, 언스테이크, 보상                                      |
| **gov/governance** | 제안, 투표, 실행                                                |
| **gov/staker**     | 위임, 보상                                                      |
| **launchpad**      | 프로젝트, 예치, 보상                                            |
| **protocol_fee**   | 수집                                                            |
| **community_pool** | 할당                                                            |

### 주요 특징

- **독립적인 버전 관리** - 각 도메인이 독립적으로 업그레이드
- **비즈니스 로직만** - 도메인 규칙에 집중
- **의존성 관리** - sys/dependency를 통한 컨트랙트 간 호출

### 디렉토리 구조

```
common/
├── v1/                        # Common 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Common 컨트랙트 v2

pool/
├── v1/                        # Pool 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Pool 컨트랙트 v2

position/
├── v1/                        # Position 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Position 컨트랙트 v2

router/
├── v1/                        # Router 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Router 컨트랙트 v2

staker/
├── v1/                        # Staker 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Staker 컨트랙트 v2

gov/
├── governance/
│   ├── v1/                    # Governance 컨트랙트 v1
│   │   ├── accessor.gno       # 스토리지 접근자
│   │   └── register.gno       # 의존성 등록
│   └── v2/                    # Governance 컨트랙트 v2
│
├── staker/
│   ├── v1/                    # Gov Staker 컨트랙트 v1
│   │   ├── accessor.gno       # 스토리지 접근자
│   │   └── register.gno       # 의존성 등록
│   └── v2/                    # Gov Staker 컨트랙트 v2
│
└── xgns/
    ├── v1/                    # xGNS 컨트랙트 v1
    │   ├── accessor.gno      # 스토리지 접근자
    │   └── register.gno      # 의존성 등록
    └── v2/                    # xGNS 컨트랙트 v2

launchpad/
├── v1/                        # Launchpad 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Launchpad 컨트랙트 v2

protocol_fee/
├── v1/                        # Protocol Fee 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Protocol Fee 컨트랙트 v2

community_pool/
├── v1/                        # Community Pool 컨트랙트 v1
│   ├── accessor.gno           # 스토리지 접근자
│   └── register.gno           # 의존성 등록
└── v2/                        # Community Pool 컨트랙트 v2
```

---

## 데이터 흐름

### 완전한 예시: 풀 스왑 작업

```
사용자 요청
     │
     ▼
┌─────────────────────────────────────────┐
│ Layer 2: pool/v2/swap.gno                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 1. sys/halt 확인                        │
│ 2. sys/access 확인                      │
│ 3. accessor.gno:                        │
│    pool/storage.Get("pools")  ────┐     │
│ 4. 비즈니스 로직 실행             │     │
│ 5. accessor.gno:                  │     │
│    pool/storage.Set("pools")  ────┤     │
└───────────────────────────────────│─────┘
                                    │
                                    ▼
┌─────────────────────────────────────────┐
│ Layer 1: pool/storage.gno                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ sys/storage.Get("pool", key)  ────┐     │
│ sys/storage.Set("pool", key)  ────┤     │
└───────────────────────────────────│─────┘
                                    │
                                    ▼
┌─────────────────────────────────────────┐
│ Layer 0: sys/storage/kv_store.gno        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ - 네임스페이스 권한 확인                │
│ - map[namespace][key]value 저장         │
│ - 타입 무관 (문자열만)                  │
└─────────────────────────────────────────┘
```

---

## 핵심 설계 원칙

### 1. 명확한 관심사 분리

```
Layer 0: "어디에 저장하고 누가 접근할 수 있나?"
Layer 1: "무엇을 저장하고 어떻게 접근하나?"
Layer 2: "어떤 비즈니스 규칙을 적용하나?"
```

### 2. 단방향 의존성

```
Layer 2 → Layer 1 → Layer 0
(하위 Layer은 상위 Layer을 인식하지 않음)
```

### 3. 버전 독립성

```
pool/v1, pool/v2 → 동일한 pool/storage 사용
pool/v2 배포가 pool/v1에 영향을 주지 않음
sys/storage를 통해 데이터 공유
```

### 4. 네임스페이스 격리

```
각 도메인은 격리된 스토리지 네임스페이스를 가짐
pool → "pool" 네임스페이스
position → "position" 네임스페이스
도메인 간 데이터 손상 방지
```

---

## 업그레이드 프로세스

### 예시: Pool을 v1에서 v2로 업그레이드

```
┌─────────────────────────────────────────┐
│ 단계 1: pool/v2 배포                    │
│ - 향상된 기능의 새 컨트랙트             │
│ - TWAP 오라클 추가                      │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 단계 2: sys/rbac에 등록                 │
│ - rbac.UpdateRoleAddressNextVersion()   │
│ - POOL 역할이 이제 v2 주소를 가리킴     │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 단계 3: pool/upgrade.gno 호출           │
│ - v2를 주 버전으로 활성화               │
│ - sys/dependency 레지스트리 업데이트    │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 결과:                                   │
│ - pool/v1 여전히 작동                   │
│ - pool/v2 현재 활성화                   │
│ - 데이터 마이그레이션 불필요            │
│ - 무중단                                │
└─────────────────────────────────────────┘
```

---

## 이점

### 1. 무중단 업그레이드

- 구버전과 신버전이 공존
- 점진적 트래픽 마이그레이션
- 즉시 롤백 가능

### 2. 데이터 마이그레이션 불필요

- 단일 중앙 집중식 스토리지 (`sys/storage`)
- 모든 버전이 동일한 데이터 공유
- 추가 전용 스키마 진화

### 3. 독립적인 컨트랙트 업그레이드

- position을 업그레이드하지 않고 pool 업그레이드 가능
- 의존성 검증으로 호환성 보장
- `sys/dependency`가 버전 매트릭스 관리

### 4. 강력한 접근 제어

- 네임스페이스 기반 격리
- 역할 기반 권한 부여
- 버전별 중단 메커니즘

### 5. 간소화된 테스트

- 각 Layer 독립적으로 테스트
- 명확한 경계와 인터페이스
- 의존성 모킹 용이

---

## 보안 고려사항

### 1. 네임스페이스 권한 부여

- 각 네임스페이스에 권한이 부여된 컨트랙트 목록
- `sys/storage`가 쓰기 전에 호출자 검증
- 무단 데이터 접근 방지

### 2. 버전 검증

- `sys/dependency`가 버전 호환성 추적
- 호환되지 않는 버전 호출 거부
- 안전한 컨트랙트 간 통신

### 3. 긴급 중단

- 버전별 중단 기능
- 독립적인 중단 상태
- v1은 유지하면서 v2만 중단 가능

### 4. 불변 인프라

- 레이어0과 레이어1은 업그레이드 불가
- 핵심 보안 보장 유지
- 예측 가능한 시스템 동작
