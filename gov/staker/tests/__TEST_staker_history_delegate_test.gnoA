package staker

import (
	"testing"
	"time"

	"gno.land/p/demo/testutils"
)

func TestGetDelegatedCumulative(t *testing.T) {
	delegateAddr := testutils.TestAddress("delegate")
	delegate := delegateAddr.String()

	defer func() {
		if r := recover(); r != nil {
			t.Fatalf("GetAverageDelegated panicked: %v", r)
		}
	}()

	// simulate time passing and additional stakes
	currentTime := uint64(1000)
	delegationModifiedHistory[delegateAddr] = []ModifiedDelegationHistory{
		{delegatedAmount: 1000, delegatedTimestamp: currentTime},       // 1000
		{delegatedAmount: 1500, delegatedTimestamp: currentTime + 100}, // 1100
		{delegatedAmount: 2000, delegatedTimestamp: currentTime + 200}, // 1200
	}

	tests := []struct {
		name           string
		timestamp      uint64
		expectedResult string
	}{
		{
			name:           "period +50",
			timestamp:      currentTime + 50, // 1050
			expectedResult: "50000",          // (1000 * 50)
		},
		{
			name:           "period +100",
			timestamp:      currentTime + 100, // 1100
			expectedResult: "100000",          // (1000 * 100)
		},
		{
			name:           "period +150",
			timestamp:      currentTime + 150, // 1100
			expectedResult: "225000",          // (1000 * 150 + 1500 * 50)
		},
		{
			name:           "period +200",
			timestamp:      currentTime + 200, // 1200
			expectedResult: "350000",          // (1000 * 200 + 1500 * 100 + 2000 * 0)
		},
		{
			name:           "period +250",
			timestamp:      currentTime + 250, // 1250
			expectedResult: "575000",          // (1000 * 250 + 1500 * 150 + 2000 * 50)
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := GetDelegatedCumulative(delegate, tt.timestamp)
			if result != tt.expectedResult {
				t.Errorf("Expected %s, got %s", tt.expectedResult, result)
			}
		})
	}
}

func TestGetAverageDelegated(t *testing.T) {
	delegateAddr := testutils.TestAddress("delegate")
	delegate := delegateAddr.String()

	defer func() {
		if r := recover(); r != nil {
			t.Fatalf("GetAverageDelegated panicked: %v", r)
		}
	}()

	// simulate time passing and additional stakes
	currentTime := uint64(1000)
	delegationModifiedHistory[delegateAddr] = []ModifiedDelegationHistory{
		{delegatedAmount: 1000, delegatedTimestamp: currentTime},       // 1000
		{delegatedAmount: 1500, delegatedTimestamp: currentTime + 100}, // 1100
		{delegatedAmount: 2000, delegatedTimestamp: currentTime + 200}, // 1200
	}

	tests := []struct {
		name           string
		start          uint64
		end            uint64
		expectedResult string
	}{
		{
			name:           "Full period average",
			start:          currentTime,       // 1000
			end:            currentTime + 200, // 1200
			expectedResult: "1750",            // (1000*200 + 1500*100 + 2000*0) / 200
		},
		{
			name:           "Partial period average",
			start:          currentTime + 50,  // 1050
			end:            currentTime + 150, // 1150
			expectedResult: "1750",            // (1000*100 + 1500*50) / 100
		},
		{
			name:           "Single point in time",
			start:          currentTime + 100, // 1100
			end:            currentTime + 100, // 1100
			expectedResult: "0",               // end-start is 0, so average is 0
		},
		{
			name:           "Period before any stakes",
			start:          currentTime - 100,
			end:            currentTime - 50,
			expectedResult: "0",
		},
		{
			name:           "Period after all recorded stakes",
			start:          currentTime + 300, // 1300
			end:            currentTime + 400, // 1400
			expectedResult: "4500",            // (1000 * 100 + 1500 * 100 + 2000 * 100) / 100
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := GetAverageDelegated(delegate, tt.start, tt.end)
			if result != tt.expectedResult {
				t.Errorf("Expected %s, got %s", tt.expectedResult, result)
			}
		})
	}
}

func TestGetAverageDelegatedOverLast(t *testing.T) {
	delegateAddr := testutils.TestAddress("delegate")
	delegate := delegateAddr.String()

	defer func() {
		if r := recover(); r != nil {
			t.Fatalf("GetAverageDelegatedOverLast panicked: %v", r)
		}
	}()

	// Set up delegation history
	now := uint64(time.Now().Unix())
	delegationModifiedHistory[delegateAddr] = []ModifiedDelegationHistory{
		{delegatedAmount: 1000, delegatedTimestamp: now - 100},
		{delegatedAmount: 2000, delegatedTimestamp: now - 50},
		{delegatedAmount: 3000, delegatedTimestamp: now},
	}

	avg := GetAverageDelegatedOverLast(delegate, uint64(100))
	if avg != "2000" { // (1000*100 + 2000*50) / 100
		t.Errorf("Expected 2000, got %s", avg)
	}
}

func TestGetCurrentDelegated(t *testing.T) {
	delegate1 := testutils.TestAddress("delegate1")
	delegate2 := testutils.TestAddress("delegate2")

	// Set up delegation history for delegate1
	delegationModifiedHistory[delegate1] = []ModifiedDelegationHistory{
		{delegatedAmount: 1000, delegatedTimestamp: 100},
		{delegatedAmount: 1500, delegatedTimestamp: 200},
		{delegatedAmount: 2000, delegatedTimestamp: 300},
	}

	tests := []struct {
		name           string
		delegate       string
		expectedResult string
	}{
		{
			name:           "Delegate with history",
			delegate:       delegate1.String(),
			expectedResult: "2000",
		},
		{
			name:           "Delegate without history",
			delegate:       delegate2.String(),
			expectedResult: "0",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := GetCurrentDelegated(tt.delegate)
			if result != tt.expectedResult {
				t.Errorf("Expected %s, got %s", tt.expectedResult, result)
			}
		})
	}
}

func TestGetDelegatedAt(t *testing.T) {
	delegateAddr := testutils.TestAddress("delegate")
	delegate := delegateAddr.String()

	delegationModifiedHistory[delegateAddr] = []ModifiedDelegationHistory{
		{delegatedAmount: 1000, delegatedTimestamp: 100},
		{delegatedAmount: 1500, delegatedTimestamp: 200},
		{delegatedAmount: 2000, delegatedTimestamp: 300},
	}

	tests := []struct {
		name           string
		timestamp      uint64
		expectedResult string
	}{
		{
			name:           "Before first delegation",
			timestamp:      50,
			expectedResult: "0",
		},
		{
			name:           "At first delegation",
			timestamp:      100,
			expectedResult: "1000",
		},
		{
			name:           "Between first and second delegation",
			timestamp:      150,
			expectedResult: "1000",
		},
		{
			name:           "At second delegation",
			timestamp:      200,
			expectedResult: "1500",
		},
		{
			name:           "At last delegation",
			timestamp:      300,
			expectedResult: "2000",
		},
		{
			name:           "After last delegation",
			timestamp:      400,
			expectedResult: "2000",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := GetDelegatedAt(delegate, tt.timestamp)
			if result != tt.expectedResult {
				t.Errorf("Expected %s, got %s", tt.expectedResult, result)
			}
		})
	}

	t.Run("Non-existent delegate", func(t *testing.T) {
		dummy := testutils.TestAddress("dummy").String()
		result := GetDelegatedAt(dummy, uint64(200))
		if result != "0" {
			t.Errorf("Expected 0, got %s", result)
		}
	})
}
