package staker

import (
	"std"
	"testing"

	"gno.land/p/demo/testutils"
	"gno.land/p/demo/uassert"
	pusers "gno.land/p/demo/users"

	"gno.land/r/gnoswap/v1/common"
	"gno.land/r/gnoswap/v1/consts"

	en "gno.land/r/gnoswap/v1/emission"
	pl "gno.land/r/gnoswap/v1/pool"
	pn "gno.land/r/gnoswap/v1/position"
	rr "gno.land/r/gnoswap/v1/router"

	"gno.land/r/gnoswap/v1/gnft"
	"gno.land/r/gnoswap/v1/gns"

	"gno.land/r/demo/wugnot"
	"gno.land/r/onbloc/bar"
	"gno.land/r/onbloc/baz"
	"gno.land/r/onbloc/foo"
	"gno.land/r/onbloc/qux"
)

const (
	ugnotDenom string = "ugnot"
	ugnotPath  string = "gno.land/r/gnoswap/v1/pool:ugnot"
	wugnotPath string = "gno.land/r/demo/wugnot"
	gnsPath    string = "gno.land/r/gnoswap/v1/gns"
	barPath    string = "gno.land/r/onbloc/bar"
	bazPath    string = "gno.land/r/onbloc/baz"
	fooPath    string = "gno.land/r/onbloc/foo"
	oblPath    string = "gno.land/r/onbloc/obl"
	quxPath    string = "gno.land/r/onbloc/qux"

	fee100      uint32 = 100
	fee500      uint32 = 500
	fee3000     uint32 = 3000
	maxApprove  uint64 = 18446744073709551615
	max_timeout int64  = 9999999999

	genesisBlockHeight = int64(123)
)

var (
	wugnotAddr = consts.WUGNOT_ADDR
	stakerAddr = consts.STAKER_ADDR

	externalCreator = testutils.TestAddress("externalCreator")
)

func TestFullInternalExternal(t *testing.T) {
	testInit(t)
	testCreatePoolWugnotGns3000Tier01(t)
	testCreateExternalIncentiveGns(t) // GNS로 리워드 생성 ( gnot:gns:0.3% 풀은 인터널도 GNS고 익스터널도 GNS )
	testMintPos01InRange(t)

	testCreateBarBaz500Tier02(t) // 포지션 아예 없어서 커뮤니티 풀로 빠져야 함
	testMintPos02InRange(t)      // bar:baz:0.05%
	testMintPos03OutRange(t)     // gnot:gns:0.3%
	testMintPos04OutRange(t)     // bar:baz:0.05%
	testMintPos05OutRange(t)     // gnot:gns:0.3%
	testMintPos06OutRange(t)     // bar:baz:0.05%

	testStakeToken01(t) // 여기 직전까지는 스테이킹 된 포지션 없어서 wugnot gns 0.3% 풀에 쌓인 리워드 커뮤니티 풀로 빠져야 함
	testStakeToken02(t) //
	testStakeToken03(t) //
	testStakeToken04(t) //
	testStakeToken05(t) //
	testStakeToken06(t) //

	testCollectRewardAllForWarmUp30(t)  // 10블록 쯤 증가시키고, 한 블록 내에서 1~6번 포지션 리워드 수령 (웜업 30% 구간)
	testCollectRewardAllForWarmUp50(t)  // 웜업 50% 까지 증가시키고, 한 블록 내에서 1~6번 포지션 리워드 수령
	testCollectRewardAllForWarmUp70(t)  // 웜업 70% 까지 증가시키고, 한 블록 내에서 1~6번 포지션 리워드 수령
	testCollectRewardAllForWarmUp100(t) // 웜업 100% 까지 증가시키고, 한 블록 내에서 1~6번 포지션 리워드 수령

	testSwapExactIn(t)
	testSwapExactOut(t)

	testCreatePoolBarFoo100Tier03(t)    // 틱 600000, 인터널 티어 #3
	testOneClickStakingPos07OutRange(t) // bar:foo:0.01%, 원클릭 스테이킹으로 애초에 outRange로 스테이킹 됨 => 블록 증가 후 7번 포지션 리워드 수령 해보면 outRange기 떄문에 커뮤 풀로 빠져야 함

	testUnstakeToken01(t) // 전체 스테이킹 된 유동성 변경

	// EXTERNAL ONLY
	testCreatePoolBazQux3000ExternalOnly(t) // 풀 만드는데 익스터널 인센티브만 있는 풀임
	testCreateExternalIncentiveBaz(t)       // 위에서 만든 풀 대상으로 baz 익스터널 인센티브 생성
	testMintPos08InRange(t)                 // 포지션 생성
	testStakeToken08(t)                     // 스테이킹
	testCollectReward08(t)                  // 10 블록 쯤 증가시키고 리워드 수령하면 0으로 나와야 함 (익스터널 아직 시작 안 됨)
	testStartExternalIncentive(t)           // 익스터널 인센티브 시작
	testCollectReward08AfterStart(t)        // 10 블록 증가 후 리워드 수령하면 웜업 구간에 맞는 10 블록 만큼의 리워드 나와야 함 ( 몇 퍼센트 구간인지는 위에서 익스터널 시작시킬려고 몇 블록을 스킵했는지에 따라 다름)
	testEndExternalIncentiveBaz(t)          // baz 인센티브 종료 ( 페널티 수량 환불되야 함 )

	testReStakeTokenPos01(t) // 스테이킹 해서 웝업 100% 찍었다가 언스테이킹 된 토큰 다시 스테이킹 ( 웜업 처음(30%)부터 적용되야 함 )

	testChangeAvgBlockTimeTo4000(t)     // 블록 시간 2배로 증가
	testChangeDistributionPctByAdmin(t) //  스테이커한테 가는 에미션 비율 변경
}

func testInit(t *testing.T) {
	t.Run("initialize", func(t *testing.T) {
		println("[", std.GetHeight(), "] [testInit]")
		std.TestSetRealm(adminRealm)

		// 언스테이킹 수수료 0으로 바꿈 // 계산 편함
		SetUnstakingFeeByAdmin(0)
		println("[", std.GetHeight(), "] [testInit] SetUnstakingFeeByAdmin(0)")

		// 에미션 분배 커뮤니티 비율 0%로 (대신 devOps 한테 많이 가게))
		// 에미션 기본 분배 대상 4개 중에 커뮤니티 풀한테 주는 비율이 이미 있어서 인터널 페널티 발생 시 잔액에 영향을 주기 때문에 애초에 커뮤니티 풀한테는 자동으로 안 풀리게 하고 테스트하는게 깔끔
		en.ChangeDistributionPctByAdmin(
			1, 7500, // 스테이커
			2, 2500, // 데브옵스
			3, 0, // 커뮤니티풀
			4, 0, // xGNS
		)
		println("[", std.GetHeight(), "] [testInit] ChangeDistributionPctByAdmin(75, 25, 0, 0)")

		// admin 계정한테 wugnot 토큰 미리 좀 넉넉하게 할당
		std.TestIssueCoins(adminAddr, std.Coins{{"ugnot", 100_000_000_000_000}})
		banker := std.GetBanker(std.BankerTypeRealmSend)
		banker.SendCoins(adminAddr, wugnotAddr, std.Coins{{"ugnot", 50_000_000_000_000}})
		std.TestSetOrigSend(std.Coins{{"ugnot", 50_000_000_000_000}}, nil)
		wugnot.Deposit()
		std.TestSetOrigSend(nil, nil)
		uassert.Equal(t, uint64(50_000_000_000_000), wugnot.BalanceOf(pusers.AddressOrName(adminAddr)))
		uassert.Equal(t, "50000000000000ugnot", (banker.GetCoins(adminAddr).String()))
	})
}

func testCreatePoolWugnotGns3000Tier01(t *testing.T) {
	t.Run("create pool gnot:gns:0.3%", func(t *testing.T) {
		println("[", std.GetHeight(), "] [create pool gnot:gns:0.3%]")
		std.TestSetRealm(adminRealm)

		gns.Approve(a2u(consts.POOL_ADDR), consts.UINT64_MAX)
		pl.CreatePool(wugnotPath, gnsPath, 3000, common.TickMathGetSqrtRatioAtTick(0).ToString()) // current tick 0
		println("[", std.GetHeight(), "] Already Set PoolTier 1")

		uassert.Equal(t, uint64(100000000000000), gns.TotalSupply())
		uassert.Equal(t, uint64(0), gnsBalance(consts.EMISSION_ADDR))
		uassert.Equal(t, uint64(0), gnsBalance(consts.STAKER_ADDR))
		uassert.Equal(t, uint64(0), gnsBalance(consts.DEV_OPS))
		std.TestSkipHeights(3)
	})
}

func testCreateExternalIncentiveGns(t *testing.T) {
	t.Run("create external incentive gns for gnot:gns:0.3% pool", func(t *testing.T) {

		println("[", std.GetHeight(), "] [create external incentive gns for gnot:gns:0.3% pool]")
		std.TestSetRealm(adminRealm)

		gns.Approve(a2u(consts.STAKER_ADDR), consts.UINT64_MAX) // this includes depositGnsAmount
		CreateExternalIncentive(
			"gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000",
			consts.GNS_PATH,
			20000000,
			1234569600,
			1234569600+TIMESTAMP_90DAYS,
		)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos01InRange(t *testing.T) {
	t.Run("mint position 01 in range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 01 in range]")
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			wugnotPath,
			gnsPath,
			fee3000,
			int32(-60),
			int32(60),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCreateBarBaz500Tier02(t *testing.T) {
	t.Run("create bar:baz:500 pool, and set internal emission tier #2", func(t *testing.T) {
		println("[", std.GetHeight(), "] [create bar:baz:500 pool, and set internal emission tier #2]")
		std.TestSetRealm(adminRealm)

		gns.Approve(a2u(consts.POOL_ADDR), consts.UINT64_MAX)
		pl.CreatePool(barPath, bazPath, 500, common.TickMathGetSqrtRatioAtTick(0).ToString())

		println("[", std.GetHeight(), "] (gno.land/r/onbloc/bar:gno.land/r/onbloc/baz:500) Set PoolTier 2")
		SetPoolTierByAdmin("gno.land/r/onbloc/bar:gno.land/r/onbloc/baz:500", 2)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos02InRange(t *testing.T) {
	t.Run("mint position 02 in range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 02 in range]")
		std.TestSetRealm(adminRealm)

		bar.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		baz.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			barPath,
			bazPath,
			fee500,
			int32(-60),
			int32(60),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos03OutRange(t *testing.T) {
	t.Run("mint position 03 out range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 03 out range]")
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			wugnotPath,
			gnsPath,
			fee3000,
			int32(60),
			int32(120),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos04OutRange(t *testing.T) {
	t.Run("mint position 04 out range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 04 out range]")
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			barPath,
			bazPath,
			fee500,
			int32(60),
			int32(120),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos05OutRange(t *testing.T) {
	t.Run("mint position 05 out range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 05 out range]")
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			wugnotPath,
			gnsPath,
			fee3000,
			int32(-120),
			int32(-60),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testMintPos06OutRange(t *testing.T) {
	t.Run("mint position 06 out range", func(t *testing.T) {
		println("[", std.GetHeight(), "] [mint position 06 out range]")
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		pn.Mint(
			barPath,
			bazPath,
			fee500,
			int32(-120),
			int32(-60),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)
		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken01(t *testing.T) {
	t.Run("stake token 01", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward Available ******] [stake token 01]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(1))
		StakeToken(1)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken02(t *testing.T) {
	t.Run("stake token 02", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward Available ******] [stake token 02]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(2))
		StakeToken(2)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken03(t *testing.T) {
	t.Run("stake token 03", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward No OutRange ******] [stake token 03]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(3))
		StakeToken(3)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken04(t *testing.T) {
	t.Run("stake token 04", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward No OutRange ******] [stake token 04]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(4))
		StakeToken(4)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken05(t *testing.T) {
	t.Run("stake token 05", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward No OutRange ******] [stake token 05]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(5))
		StakeToken(5)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testStakeToken06(t *testing.T) {
	t.Run("stake token 06", func(t *testing.T) {
		println("[", std.GetHeight(), "][****** Reward No OutRange ******] [stake token 06]")
		std.TestSetRealm(adminRealm)

		gnft.Approve(stakerAddr, common.TokenIdFrom(6))
		StakeToken(6)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCollectRewardAllForWarmUp30(t *testing.T) {
	t.Run("collect reward for all position, while warm up is in 30", func(t *testing.T) {
		println("[", std.GetHeight(), "] [collect reward for all position, while warm up is in 30%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCollectRewardAllForWarmUp50(t *testing.T) {
	msInDay := int64(86400000)
	blocksInDay := msInDay / int64(gns.GetAvgBlockTimeInMs())
	blocksIn5Days := int64(5 * blocksInDay)
	blocksIn10Days := int64(10 * blocksInDay)
	blocksIn30Days := int64(30 * blocksInDay)

	t.Run("make warm up to 50% (currently reward for 30% and 50% are mixed)", func(t *testing.T) {
		std.TestSkipHeights(blocksIn5Days)
		println("[", std.GetHeight(), "] [made all staked position warm up to 50%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		std.TestSkipHeights(1)
	})

	t.Run("only single block for 50% warm up", func(t *testing.T) {
		println("[", std.GetHeight(), "] [collect reward for all position, while warm up is in 50%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCollectRewardAllForWarmUp70(t *testing.T) {
	msInDay := int64(86400000)
	blocksInDay := msInDay / int64(gns.GetAvgBlockTimeInMs())
	blocksIn5Days := int64(5 * blocksInDay)
	blocksIn10Days := int64(10 * blocksInDay)
	blocksIn30Days := int64(30 * blocksInDay)

	t.Run("make warm up to 70% (currently reward for 50% and 70% are mixed)", func(t *testing.T) {
		std.TestSkipHeights(blocksIn10Days)
		println("[", std.GetHeight(), "] [made all staked position warm up to 70%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("only single block for 70% warm up", func(t *testing.T) {
		println("[", std.GetHeight(), "] [collect reward for all position, while warm up is in 70%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCollectRewardAllForWarmUp100(t *testing.T) {
	msInDay := int64(86400000)
	blocksInDay := msInDay / int64(gns.GetAvgBlockTimeInMs())
	blocksIn5Days := int64(5 * blocksInDay)
	blocksIn10Days := int64(10 * blocksInDay)
	blocksIn30Days := int64(30 * blocksInDay)

	t.Run("make warm up to 100% (currently reward for 70% and 100% are mixed)", func(t *testing.T) {
		std.TestSkipHeights(blocksIn30Days)
		println("[", std.GetHeight(), "] [made all staked position warm up to 100%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("only single block for 100% warm up", func(t *testing.T) {
		println("[", std.GetHeight(), "] [collect reward for all position, while warm up is in 100%]")
		std.TestSetRealm(adminRealm)

		CollectReward(1, false)
		CollectReward(2, false)
		CollectReward(3, false)
		CollectReward(4, false)
		CollectReward(5, false)
		CollectReward(6, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testSwapExactIn(t *testing.T) {
	t.Run("swap token0 to token1 500 // swap #1", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactInSwapRoute(
			wugnotPath, // inputToken
			gnsPath,    // outputToken
			"500",      // finalAmountIn
			"gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000", // RouteArr
			"100",       // quoteArr
			"0",         // amountOutMin
			max_timeout, // deadline
		)
		// tick changed
		// > from 0 to -30

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 01 // #1", func(t *testing.T) {
		// position-01 range
		// > from -60 ~ 60
		// stil in range
		// - there are some rewards

		std.TestSetRealm(adminRealm)
		CollectReward(1, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token0 to token1 500 // swap #2", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactInSwapRoute(
			wugnotPath, // inputToken
			gnsPath,    // outputToken
			"500",      // finalAmountIn
			"gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000", // RouteArr
			"100",       // quoteArr
			"0",         // amountOutMin
			max_timeout, // deadline
		)
		// tick changed
		// > from 0 to -30

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 01 // #2", func(t *testing.T) {
		// position-01 range
		// > from -60 ~ 60
		// stil in range
		// - there are some rewards

		std.TestSetRealm(adminRealm)
		CollectReward(1, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token0 to token1 500 // swap #3", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactInSwapRoute(
			wugnotPath, // inputToken
			gnsPath,    // outputToken
			"500",      // finalAmountIn
			"gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000", // RouteArr
			"100",       // quoteArr
			"0",         // amountOutMin
			max_timeout, // deadline
		)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
	// tick changed
	// > from -60 to -90

	t.Run("check reward for position 01 // #3-1", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		CollectReward(1, false) // should have reward for block that exeucted swap

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
	t.Run("check reward for position 01 // #3-2", func(t *testing.T) {
		// position-01 range
		// > from -60 ~ 60
		// out range

		std.TestSetRealm(adminRealm)
		CollectReward(1, false) // should have no reward since position is out of range

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token0 to token1 500 // swap #4", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactInSwapRoute(
			wugnotPath, // inputToken
			gnsPath,    // outputToken
			"500",      // finalAmountIn
			"gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000", // RouteArr
			"100",       // quoteArr
			"0",         // amountOutMin
			max_timeout, // deadline
		)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
	// tick changed
	// > from -90 to -119
	// position-01 range
	// > from -60 ~ 60
	// out range
	t.Run("check reward for position 01 // #4", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		CollectReward(1, false) // should have reward for block that exeucted swap
		std.TestSkipHeights(1)
	})
}

func testSwapExactOut(t *testing.T) {
	t.Run("swap token1 to token1 0 // swap #1", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactOutSwapRoute(
			gnsPath,    // inputToken
			wugnotPath, // outputToken
			"500",      // amountOut
			"gno.land/r/gnoswap/v1/gns:gno.land/r/demo/wugnot:3000", // RouteArr
			"100",       // quoteArr
			"1000",      // amountInMax
			max_timeout, // deadline
		)
		// tick changed
		// > from -119 ~ -89

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 03 // #1", func(t *testing.T) {
		// position-05 range
		// > from 60 ~ 120
		// out range

		std.TestSetRealm(adminRealm)
		CollectReward(3, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token1 to token1 0 // swap #2", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactOutSwapRoute(
			gnsPath,    // inputToken
			wugnotPath, // outputToken
			"500",      // amountOut
			"gno.land/r/gnoswap/v1/gns:gno.land/r/demo/wugnot:3000", // RouteArr
			"100",       // quoteArr
			"1000",      // amountInMax
			max_timeout, // deadline
		)
		// tick changed
		// > from -89 ~ -60

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 03 // #2", func(t *testing.T) {
		// position-05 range
		// > from 60 ~ 120
		// out range

		std.TestSetRealm(adminRealm)
		CollectReward(3, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token1 to token1 0 // swap #3", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactOutSwapRoute(
			gnsPath,    // inputToken
			wugnotPath, // outputToken
			"500",      // amountOut
			"gno.land/r/gnoswap/v1/gns:gno.land/r/demo/wugnot:3000", // RouteArr
			"100",       // quoteArr
			"1000",      // amountInMax
			max_timeout, // deadline
		)
		// tick changed
		// > from -60 ~ -30

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 03 // #3", func(t *testing.T) {
		// position-05 range
		// > from 60 ~ 120
		// out range

		std.TestSetRealm(adminRealm)
		CollectReward(3, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("swap token1 to token1 0 // swap #4", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		wugnot.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.ROUTER_ADDR), consts.UINT64_MAX)

		tokenIn, tokenOut := rr.ExactOutSwapRoute(
			gnsPath,    // inputToken
			wugnotPath, // outputToken
			"500",      // amountOut
			"gno.land/r/gnoswap/v1/gns:gno.land/r/demo/wugnot:3000", // RouteArr
			"100",       // quoteArr
			"1000",      // amountInMax
			max_timeout, // deadline
		)
		// tick changed
		// > from -30 ~ 0

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("check reward for position 03 // #4", func(t *testing.T) {
		// position-05 range
		// > from 60 ~ 120
		// out range

		std.TestSetRealm(adminRealm)
		CollectReward(3, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCreatePoolBarFoo100Tier03(t *testing.T) {
	t.Run("create bar:foo:100 pool, and set internal emission tier #3", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		pl.CreatePool(barPath, fooPath, fee100, common.TickMathGetSqrtRatioAtTick(600000).ToString())
		std.TestSkipHeights(1)

		// height 1944165
		SetPoolTierByAdmin("gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:100", 3)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testOneClickStakingPos07OutRange(t *testing.T) {
	t.Run("mint and stake grc20 pair (pos #7)", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		bar.Approve(a2u(consts.POOL_ADDR), consts.UINT64_MAX)
		foo.Approve(a2u(consts.POOL_ADDR), consts.UINT64_MAX)

		lpTokenId, liquidity, amount0, amount1, poolPath := MintAndStake(
			barPath,    // token0
			fooPath,    // token1
			fee100,     // fee
			int32(-60), // tickLower
			int32(60),  // tickUpper
			"1000",     // amount0Desired
			"1000",     // amount1Desired
			"0",        // amount0Min
			"0",        // amount1Min
			max_timeout,
		)
		uassert.Equal(t, lpTokenId, uint64(7))

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("collect reward for position 07", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		oldCommunityPool := gns.BalanceOf(common.AddrToUser(consts.COMMUNITY_POOL_ADDR))
		CollectReward(7, false)
		// height 1944167

		newCommunityPool := gns.BalanceOf(common.AddrToUser(consts.COMMUNITY_POOL_ADDR))
		uassert.Equal(t, uint64(4280820), newCommunityPool-oldCommunityPool)
		// 현재 모든 인터널 티어에 대해서 풀이 존재
		// > 블록 당 에미션 리워드 스테이커 비율 10702054
		// > 티어 1, 50% ~= 5351027
		// > 티어 2, 30% ~= 3210616
		// > 티어 3, 20% ~= 2140410

		// bar:foo:0.1% 풀이 1944165 블록에서 티어 3으로 설정되었고, 현재 블록은 1944167
		// 2 블록 만큼의 리워드(2140410 * 2 = 4280820)가 해당 풀까지 전달되었으나 분배 할 포지션이 없는 관계로 커뮤니티 풀로 빠져야 함

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testUnstakeToken01(t *testing.T) {
	t.Run("unstake token 01", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		UnstakeToken(1, false)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("collect reward for position 03 (has same pool with position 01)", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		// wugnot:gns:0.3% // currentTick: 0
		// 1번 포지션 inRange // -60 ~ 60 || 언스테이킹 됨
		// 3번 포지션 outRange // 60 ~ 120
		// 5번 포지션 outRange // -120 ~ -60
		// > 결국 해당 풀은 outRange 포지션만 있기에 해당 풀에 분배되는 에미션 리워드(티어1 = 5351027)는 커뮤니티 풀로 빠져야 함

		oldCommuGns := gns.BalanceOf(common.AddrToUser(consts.COMMUNITY_POOL_ADDR))
		CollectReward(3, false) // 더미 수령
		newCommuGns := gns.BalanceOf(common.AddrToUser(consts.COMMUNITY_POOL_ADDR))
		uassert.Equal(t, uint64(5351027), newCommuGns-oldCommuGns)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)

	})
}

func testCreatePoolBazQux3000ExternalOnly(t *testing.T) {
	t.Run("create pool baz:qux:0.3%", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		pl.CreatePool(bazPath, quxPath, 3000, common.TickMathGetSqrtRatioAtTick(0).ToString()) // current tick 0

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testCreateExternalIncentiveBaz(t *testing.T) {
	t.Run("create external incentive baz for baz:qux:0.3% pool", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		baz.Transfer(common.AddrToUser(externalCreator), 20000000)         // for external incentive
		gns.Transfer(common.AddrToUser(externalCreator), depositGnsAmount) // for deposit

		std.TestSetRealm(std.NewUserRealm(externalCreator))
		baz.Approve(a2u(consts.STAKER_ADDR), 20000000)
		gns.Approve(a2u(consts.STAKER_ADDR), depositGnsAmount)

		CreateExternalIncentive(
			"gno.land/r/onbloc/baz:gno.land/r/onbloc/qux:3000",
			bazPath,
			20000000,
			1238457600,
			1238457600+TIMESTAMP_90DAYS,
		)
		// startHeight 1944978
		// endHeight 5832978

		// 5832978 - 1944978 = 3888000 ( incentive block duration )
		// 20000000 / 3888000 = 5.1440329218 ( amount of baz reward per block )

		checkGnsBalance(t, depositGnsAmount)
		std.TestSkipHeights(1)
	})
}

func testMintPos08InRange(t *testing.T) {
	t.Run("mint position 08 in range", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		baz.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		qux.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		std.TestSkipHeights(1)
		pn.Mint(
			bazPath,
			quxPath,
			fee3000,
			int32(-60),
			int32(60),
			"1000",
			"1000",
			"0",
			"0",
			max_timeout,
			adminAddr,
			adminAddr,
		)

		checkGnsBalance(t, depositGnsAmount)
		std.TestSkipHeights(1)
	})
}

func testStakeToken08(t *testing.T) {
	t.Run("stake token 08", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		gnft.Approve(stakerAddr, common.TokenIdFrom(8))
		StakeToken(8)

		checkGnsBalance(t, depositGnsAmount)
		std.TestSkipHeights(1)
	})
}

func testCollectReward08(t *testing.T) {
	t.Run("collect reward for 08 position, baz incentive not yet started", func(t *testing.T) {
		std.TestSkipHeights(9)
		std.TestSetRealm(adminRealm)

		oldBaz := baz.BalanceOf(common.AddrToUser(adminAddr))
		CollectReward(8, false)

		newBaz := baz.BalanceOf(common.AddrToUser(adminAddr))
		uassert.Equal(t, uint64(0), newBaz-oldBaz)
		// 익스터널 인센티브가 시작되지 않았기에 리워드가 0

		checkGnsBalance(t, depositGnsAmount)
		std.TestSkipHeights(1)
	})
}

func testStartExternalIncentive(t *testing.T) {
	t.Run("external incentive start block skip", func(t *testing.T) {
		std.TestSkipHeights(1944978 - std.GetHeight())
		std.TestSkipHeights(10)
	})
}

func testCollectReward08AfterStart(t *testing.T) {
	t.Run("collect reward for 08 position", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		oldBaz := baz.BalanceOf(common.AddrToUser(adminAddr))
		CollectReward(8, false)
		newBaz := baz.BalanceOf(common.AddrToUser(adminAddr))

		uassert.True(t, isNear(t, uint64(15), newBaz-oldBaz))
		// 5 * 10 * 30% = 15 // user receives
		// > bar reward amount per block is 5.1440329218 == 5
		// > 10 block skipped after incentive start
		// > position08 staked duration is 812 ( which is 30% warmUp period )

		checkGnsBalance(t, depositGnsAmount)
		std.TestSkipHeights(1)
	})
}

func testEndExternalIncentiveBaz(t *testing.T) {
	t.Run("end external incentive bar", func(t *testing.T) {
		std.TestSetRealm(std.NewUserRealm(externalCreator))

		// 종료 전 익스터널 만든 주소의 토큰 잔액 저장
		// - gns: 익스터널 생성 시 예치한 gns 환불
		// - baz: 익스터널로 제공한 수량 중 페널티 환불
		oldGns := gns.BalanceOf(common.AddrToUser(externalCreator))
		oldBaz := baz.BalanceOf(common.AddrToUser(externalCreator))

		// 해당 포지션에 유동성 제공한 주소의 토큰 잔액 저장
		// - baz: 리워드 수령되는지 확인
		lpOldBaz := baz.BalanceOf(common.AddrToUser(adminAddr))

		// 종료되도록 블록 증가
		std.TestSkipHeights(5832978 - std.GetHeight())
		std.TestSkipHeights(1)

		EndExternalIncentive(
			externalCreator,
			"gno.land/r/onbloc/baz:gno.land/r/onbloc/qux:3000",
			bazPath,
			1238457600,
			1238457600+TIMESTAMP_90DAYS,
			1944978,
		)
		std.TestSkipHeights(1)

		newGns := gns.BalanceOf(common.AddrToUser(externalCreator))
		newBaz := baz.BalanceOf(common.AddrToUser(externalCreator))

		// 종료 후 확인해야 할꺼

		// 1. 익스터널 생성 시 디파짓으로 넣은 gns 수량 환불
		refundGns := newGns - oldGns
		uassert.Equal(t, depositGnsAmount, refundGns, "gns refund amount mismatch")

		// 2. 웜업에 따른 페널티 수량 환불
		// > 8번 포지션에서 50개의 익스터널 리워드 발생, 30%(15개)는 리워드로, 나머지 70%(35개)가 페널티로
		refundBaz := newBaz - oldBaz
		uassert.Equal(t, uint64(35), refundBaz)

		// 3. 아직 리워드 수령하지 않은 유저는 계속 리워드 수령 가능
		std.TestSetRealm(adminRealm)
		CollectReward(8, false)
		std.TestSkipHeights(1)

		lpNewBaz := baz.BalanceOf(common.AddrToUser(adminAddr))
		uassert.True(t, lpNewBaz-lpOldBaz > 0)

		// 4. 익스터널 종료 이후 블록이 아무리 많이 생겨도 리워드가 추가적으로 발생하면 안 됨
		std.TestSkipHeights(123)
		CollectReward(8, false)
		lpNewBaz2 := baz.BalanceOf(common.AddrToUser(adminAddr))
		uassert.Equal(t, lpNewBaz, lpNewBaz2)

		checkGnsBalance(t, 0)
	})
}

func testReStakeTokenPos01(t *testing.T) {
	t.Run("re-stake token 01", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		gnft.Approve(stakerAddr, common.TokenIdFrom(1))
		StakeToken(1)

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})

	t.Run("collect reward for position 01", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		oldGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		CollectReward(1, false)
		newGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		uassert.True(t, isNear(t, uint64(1605308), newGns-oldGns))
		// 1번 포지션 다시 스테이킹 하고 1 블록 지남 (웜업 30% 부터 계산)
		// 현재 gnot:gns:0.3% 풀은 티어 1이며, 블록 당 5351027 개의 리워드가 할당 됨
		// 5351027 * 30% = 1605308.1

		checkGnsBalance(t, 0)
		std.TestSkipHeights(1)
	})
}

func testChangeAvgBlockTimeTo4000(t *testing.T) {
	// 원래 블록 시간 2초였으나 4초로 증가
	// 1 블록 당 민팅되는 GNS 수량 2배로 증가됨
	t.Run("change avg block time to 4000", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		gns.SetAvgBlockTimeInMsByAdmin(4000)
		std.TestSkipHeights(1)

		// 리워드 초기화
		CollectReward(1, false)
	})

	t.Run("collect reward position 01", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		std.TestSkipHeights(1)

		oldGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		CollectReward(1, false) // 1 블록 증가하고 리워드 확인해보면 얘한테 떨어지는 수량 거의 2배로 되야 함
		newGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		uassert.True(t, isNear(t, uint64(3210616), newGns-oldGns))

		// 블록 시간 2초일 때 블록 당 리워드 = 10702054
		// 블록 시간 4초일 때 블록 당 리워드 = 21404108
		// 티어 1, 2, 3 모두 풀이 있어서, 티어 1 풀은 50%인 10702054 할당
		// 그 중 warmUp 30% = 10702054 * 30% = 3210616.2
		std.TestSkipHeights(1)

		// 원복
		gns.SetAvgBlockTimeInMsByAdmin(2000)
	})
}

func testChangeDistributionPctByAdmin(t *testing.T) {
	t.Run("change staker's emission distribution pct to 50%", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		// 1번 포지션 리워드 수령
		CollectReward(1, false)

		en.ChangeDistributionPctByAdmin(
			1, 5000, // 스테이커
			2, 5000, // 데브옵스
			3, 0, // 커뮤니티풀
			4, 0, // xGNS
		)
		std.TestSkipHeights(1) // 1 블록 증가 했으나, 스테이커의 에미션은 비율 5%

		// 리워드 초기화
		CollectReward(1, false)
	})

	t.Run("collect reward position 01", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		std.TestSkipHeights(1)

		oldGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		CollectReward(1, false)
		newGns := gns.BalanceOf(common.AddrToUser(adminAddr))
		uassert.True(t, isNear(t, uint64(1070205), newGns-oldGns))
		// uassert.True(t, isNear(t, uint64(0), newGns-oldGns))
		// 1 블록 당 발행되는 에미션 수량 14269406
		// (원래) 75% 할당 = 10702054
		// (변경) 50% 할당 = 7134703

		// 티어 1 풀은 50% 만큼 분배 = 7134703 * 50% = 3567351.5
		// 그 중 warmUp 30% = 3567351.5 * 30% = 1070205.45

		// 원복
		en.ChangeDistributionPctByAdmin(
			1, 7500, // 스테이커
			2, 2500, // 데브옵스
			3, 0, // 커뮤니티풀
			4, 0, // xGNS
		)
		std.TestSkipHeights(1)
	})
}

func checkGnsBalance(t *testing.T, adjustAmount uint64) {
	t.Helper()

	currentHeight := std.GetHeight()
	blockPassedFromGenesis := uint64(currentHeight - genesisBlockHeight)

	oneBlockEmissionAmount := uint64(14269406)

	oneBlockStakerAmount := uint64(10702054) // 14269406*0.75
	initialStakerAmount := uint64(32106163)  // 14269406*0.75*3

	oneBlockDevOpsAmount := uint64(3567351) // 14269406*0.25
	initialDevOpsAmount := uint64(10702054) // 14269406*0.25*3

	externalIncentiveDeposit := uint64(20000000) + depositGnsAmount // externalReward + depositGns
	emissionLeft := blockPassedFromGenesis / 2
	gnsPer2Block := uint64(1)

	uassert.Equal(t, uint64(100000000000000)+(blockPassedFromGenesis*oneBlockEmissionAmount), gns.TotalSupply())

	uassert.True(t, isNear(t, uint64(0), gnsBalance(consts.EMISSION_ADDR)))

	expectStakerBalance := uint64(0) + initialStakerAmount + ((blockPassedFromGenesis - 3) * oneBlockStakerAmount) + externalIncentiveDeposit + adjustAmount
	uassert.True(t, isNear(t, expectStakerBalance+(uint64((currentHeight-126))*gnsPer2Block), gnsBalance(consts.STAKER_ADDR)+totalEmissionSent))

	expectedDevOpsBalance := uint64(0) + initialDevOpsAmount + ((blockPassedFromGenesis - 3) * oneBlockDevOpsAmount)
	uassert.True(t, isNear(t, expectedDevOpsBalance, gnsBalance(consts.DEV_OPS)))
}

// check whether the actual value is within 99.999% of the expected value
func isNear(t *testing.T, expected, actual uint64) bool {
	t.Helper()

	// 99.999%
	lower := expected * 99999 / 100000
	upper := expected * 100001 / 100000

	if lower <= actual && actual <= upper {
		return true
	}

	lower = expected - 1
	if lower > expected {
		lower = 0
	}
	upper = expected + 1

	if lower <= actual && actual <= upper {
		return true
	}

	return false
}
