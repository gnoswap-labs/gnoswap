package staker

import (
	"math"
	"std"
	"testing"

	"gno.land/p/demo/uassert"

	"gno.land/r/gnoswap/v1/common"
	"gno.land/r/gnoswap/v1/consts"

	en "gno.land/r/gnoswap/v1/emission"
	pl "gno.land/r/gnoswap/v1/pool"
	pn "gno.land/r/gnoswap/v1/position"

	"gno.land/r/gnoswap/v1/gnft"

	"gno.land/r/demo/wugnot"
	"gno.land/r/gnoswap/v1/gns"
)

func TestShortWarmUpInternalDefaultPoolCollect(t *testing.T) {
	testInit(t)
	testCreatePool(t)
	testMintWugnotGnsPos01(t)
	testStakeToken01(t)
	testCollectReward01(t)
}

func testInit(t *testing.T) {
	t.Run("init pool tiers", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		// override warm-up period for testing
		changeWarmup(t, 0, 150)
		changeWarmup(t, 1, 300)
		changeWarmup(t, 2, 900)
		changeWarmup(t, 3, math.MaxInt64)

		// set unstaking fee to 0
		SetUnstakingFeeByAdmin(0)

		// set pool creation fee to 0
		pl.SetPoolCreationFeeByAdmin(0)

		// set community pool distribution to 0% (give it to devOps)
		en.ChangeDistributionPctByAdmin(
			1, 7500,
			2, 2500,
			3, 0,
			4, 0,
		)

		// prepare wugnot
		std.TestIssueCoins(adminAddr, std.Coins{{"ugnot", 100_000_000_000_000}})
		banker := std.GetBanker(std.BankerTypeRealmSend)
		banker.SendCoins(adminAddr, consts.WUGNOT_ADDR, std.Coins{{"ugnot", 50_000_000_000_000}})
		std.TestSetOrigSend(std.Coins{{"ugnot", 50_000_000_000_000}}, nil)
		wugnot.Deposit()
		std.TestSetOrigSend(nil, nil)

		std.TestSkipHeights(1)
	})
}

func testCreatePool(t *testing.T) {
	t.Run("create pool", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		pl.CreatePool(wugnotPath, gnsPath, fee3000, "79228162514264337593543950337") // current tier 1

		std.TestSkipHeights(1)
		// 1 block minted
		// 75% of emission to staker (it is unclaimable amount, because we don't have any staked position)
	})
}

func testMintWugnotGnsPos01(t *testing.T) {
	t.Run("mint wugnot gns 3000", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		wugnot.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)
		gns.Approve(common.AddrToUser(consts.POOL_ADDR), consts.UINT64_MAX)

		tokenId, liquidity, amount0, amount1 := pn.Mint(
			wugnotPath,   // token0
			gnsPath,      // token1
			fee3000,      // fee
			int32(-1020), // tickLower
			int32(1020),  // tickUpper
			"50",         // amount0Desired
			"50",         // amount1Desired
			"1",          // amount0Min
			"1",          // amount1Min
			max_timeout,
			adminAddr,
			adminAddr,
		)

		uassert.Equal(t, tokenId, uint64(1))
		uassert.Equal(t, gnft.MustOwnerOf(tid(tokenId)), adminAddr)

		std.TestSkipHeights(1)
		// 1 block minted
		// 75% of emission to staker (it is unclaimable amount, because we don't have any staked position)
	})
}

func testStakeToken01(t *testing.T) {
	t.Run("stake token 1", func(t *testing.T) {
		std.TestSetRealm(adminRealm)

		gnft.Approve(consts.STAKER_ADDR, tid(1))
		StakeToken(1)
		std.TestSkipHeights(1)
		// 1 block staked
		// 75% of emission to staker (it is unclaimable amount, because we don't have any staked position)
	})
}

func testCollectReward01(t *testing.T) {
	t.Run("collect reward", func(t *testing.T) {
		std.TestSetRealm(adminRealm)
		// println(getPrintInfo(t))
		/*
			{
			  "height": "127",
			  "time": "1234567898",
			  "gns": {
			    "staker": "42808219",
			    "devOps": "14269404",
			    "communityPool": "0",
			    "govStaker": "0",
			    "protocolFee": "0",
			    "GnoswapAdmin": "99999999999950"
			  },
			  "pool": [
			    {
			      "poolPath": "gno.land/r/demo/wugnot:gno.land/r/gnoswap/v1/gns:3000",
			      "tier": "1",
			      "numPoolSameTier": "1",
			      "position": [
			        {
			          "lpTokenId": "1",
			          "stakedHeight": "126",
			          "stakedTimestamp": "1234567896",
			          "stakedDuration": "1",
			          "fullAmount": "10702053",
			          "ratio": "30",
			          "warmUpAmount": "3210616",
			          "full30": "10702053",
			          "give30": "3210616",
			          "penalty30": "7491437",
			          "full50": "0",
			          "give50": "0",
			          "penalty50": "0",
			          "full70": "0",
			          "give70": "0",
			          "penalty70": "0",
			          "full100": "0",
			          "give100": "0",
			          "penalty100": "0"
			        }
			      ]
			    }
			  ]
			}
		*/

		// 3 block of staker's emission reward == 32106164
		// should be sent to community pool
		// - it is duration when no position is staked

		// 1 block of staker's emission reward == 10702055
		// 30% as reward, 70% as penalty for position_01

		gnsBefore := gns.BalanceOf(admin)
		CollectReward(1, false)
		gnsAfter := gns.BalanceOf(admin)
		uassert.Equal(t, gnsAfter-gnsBefore, uint64(3210616))

		std.TestSkipHeights(1)
	})
}
