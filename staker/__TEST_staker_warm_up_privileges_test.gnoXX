package staker

import (
	"std"
	"testing"

	"gno.land/p/demo/uassert"

	"gno.land/p/demo/testutils"
)

func init() {
	// override warm-up period for testing
	changeWarmup(t, 0, 150)
	changeWarmup(t, 1, 300)
	changeWarmup(t, 2, 900)
	changeWarmup(t, 3, math.MaxInt64)

	// set unstaking fee to 0
	SetUnstakingFeeByAdmin(0)
}

func TestGetWarmUp(t *testing.T) {
	std.TestSetRealm(adminRealm)

	if GetWarmUp(100) != 901 {
		panic("GetWarmUp(100) != 901")
	}
	if GetWarmUp(70) != 301 {
		panic("GetWarmUp(70) != 301")
	}
	if GetWarmUp(50) != 151 {
		panic("GetWarmUp(50) != 151")
	}
	if GetWarmUp(30) != 1 {
		panic("GetWarmUp(30) != 1")
	}
}

func TestSetWarmUp_NoPrivileges(t *testing.T) {
	dummy := testutils.TestAddress("dummy")
	dummyRealm := std.NewUserRealm(dummy)
	std.TestSetRealm(dummyRealm)

	uassert.PanicsWithMessage(
		t,
		`[GNOSWAP-STAKER-001] caller has no permission || warm_up.gno__SetWarmUp() || only admin(g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d) or governance(g17s8w2ve7k85fwfnrk59lmlhthkjdted8whvqxd) can set warm up period, called from g1v36k6mteta047h6lta047h6lta047h6lz7gmv8`,
		func() {
			SetWarmUp(100, 100)
		},
	)
}

func TestSetWarmUp_InvalidPercent(t *testing.T) {
	std.TestSetRealm(adminRealm)

	uassert.PanicsWithMessage(
		t,
		`[GNOSWAP-STAKER-027] invalid warm up percent || warm_up.gno__SetWarmUp() || percent(10) must be 30, 50, 70, 100`,
		func() {
			SetWarmUp(10, 100)
		},
	)
}

func TestSetWarmUp(t *testing.T) {
	std.TestSetRealm(adminRealm)

	SetWarmUp(100, 100)
	if GetWarmUp(100) != 100 {
		panic("GetWarmUp(100) != 100")
	}

	SetWarmUp(70, 70)
	if GetWarmUp(70) != 70 {
		panic("GetWarmUp(70) != 70")
	}

	SetWarmUp(50, 50)
	if GetWarmUp(50) != 50 {
		panic("GetWarmUp(50) != 50")
	}

	SetWarmUp(30, 30)
	if GetWarmUp(30) != 30 {
		panic("GetWarmUp(30) != 30")
	}

}
