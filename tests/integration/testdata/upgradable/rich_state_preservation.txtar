loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission
loadpkg gno.land/r/gnoswap/protocol_fee

loadpkg gno.land/r/gnoswap/pool
loadpkg gno.land/r/gnoswap/position
loadpkg gno.land/r/gnoswap/router

loadpkg gno.land/r/gnoswap/protocol_fee/v1
loadpkg gno.land/r/gnoswap/pool/v1
loadpkg gno.land/r/gnoswap/position/v1
loadpkg gno.land/r/gnoswap/router/v1

adduserfrom gns_admin 'mnemonic here'

adduser test_admin
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $test_admin_user_addr

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

gnoland start

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetImplementationPackagePath()"
stdout "gno.land/r/gnoswap/pool/v1"

# Fund admin with ugnot for gas and deposits
gnokey maketx send -send 10000000000ugnot -to $gns_admin_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/scenario/upgrade/implements/v3_valid/pool -pkgpath gno.land/r/gnoswap/pool/v3_valid -gas-fee 1000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1

# Provide working capital
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $test_admin_user_addr -args 200000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

# Create the reference pool
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Deposit -send "150000000ugnot" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Approve -args g1y3uyaa63sjxvah2cx3c2usavwvx97kl8m2v7ye -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func CreatePool -args "gno.land/r/gnoland/wugnot" -args "gno.land/r/gnoswap/gns" -args 3000 -args 79228162514264337593543950337 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.ExistsPoolPath(\"gno.land/r/gnoland/wugnot:gno.land/r/gnoswap/gns:3000\")"
stdout true

## Mint baseline liquidity
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func Mint -send "50000000ugnot" -args gno.land/r/gnoswap/gns -args "ugnot" -args 3000 -args "-887220" -args "887220" -args 50000000 -args 50000000 -args 1 -args 1 -args 9999999999 -args $gns_admin_user_addr -args $gns_admin_user_addr -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!

## Baseline checks before generating fees
gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionLiquidity(1).ToString()"
stdout "50000000"
gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionTokensOwed1(1).ToString()"
stdout "0"

## Prepare router allowances
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1vc883gshu5z7ytk5cdynhc8c2dh67pdp4cszkp -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoland/wugnot -func Approve -args g1vc883gshu5z7ytk5cdynhc8c2dh67pdp4cszkp -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

## Generate trading fees with v1 implementation
gnokey maketx call -pkgpath gno.land/r/gnoswap/router -func ExactInSwapRoute -args "gno.land/r/gnoswap/gns" -args "gno.land/r/gnoland/wugnot" -args 1000000 -args "gno.land/r/gnoswap/gns:gno.land/r/gnoland/wugnot:3000" -args "100" -args "0" -args 9999999999 -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionTokensOwed1(1).ToString()"
stdout "0"

## Collect fees before upgrade
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func CollectFee -args 1 -args false -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionTokensOwed1(1).ToString()"
stdout "0"

## Upgrade to v3 implementation
gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func UpgradeImpl -args gno.land/r/gnoswap/pool/v3_valid -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!
stdout 'EVENTS:     \[{\"type\":\"ChangeImplementation\",\"attrs\":\[{\"key\":\"previousPackagePath\",\"value\":\"gno.land/r/gnoswap/pool/v1\"},{\"key\":\"newPackagePath\",\"value\":\"gno.land/r/gnoswap/pool/v3_valid\"}\],\"pkg_path\":\"gno.land/p/gnoswap/version_manager\"},.*,\"pkg_path\":\"gno.land/r/gnoswap/pool\"}\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetImplementationPackagePath()"
stdout "gno.land/r/gnoswap/pool/v3_valid"

## State should remain intact after upgrade
gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.ExistsPoolPath(\"gno.land/r/gnoland/wugnot:gno.land/r/gnoswap/gns:3000\")"
stdout true
gnokey query vm/qeval --data "gno.land/r/gnoswap/position.ApiGetPosition(1)"
stdout '\\"poolKey\\":\\"gno.land/r/gnoland/wugnot:gno.land/r/gnoswap/gns:3000\\"'
stdout '\\"liquidity\\":\\"50000000\\"'

## Generate fees again with the new implementation
gnokey maketx call -pkgpath gno.land/r/gnoswap/router -func ExactInSwapRoute -args "gno.land/r/gnoswap/gns" -args "gno.land/r/gnoland/wugnot" -args 2000000 -args "gno.land/r/gnoswap/gns:gno.land/r/gnoland/wugnot:3000" -args "100" -args "0" -args 9999999999 -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionTokensOwed1(1).ToString()"
stdout "0"

## Collect again to validate post-upgrade behavior
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func CollectFee -args 1 -args false -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionTokensOwed1(1).ToString()"
stdout "0"
gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPositionLiquidity(1).ToString()"
stdout "50000000"
