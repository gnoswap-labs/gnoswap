loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/onbloc/usdc
loadpkg gno.land/r/onbloc/foo
loadpkg gno.land/r/onbloc/bar
loadpkg gno.land/r/onbloc/baz
loadpkg gno.land/r/onbloc/qux
loadpkg gno.land/r/onbloc/obl

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission
loadpkg gno.land/r/gnoswap/protocol_fee

loadpkg gno.land/r/gnoswap/pool
loadpkg gno.land/r/gnoswap/position
loadpkg gno.land/r/gnoswap/staker

loadpkg gno.land/r/gnoswap/pool/v1

gnoland start

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetImplementationPackagePath()"
# stdout "gno.land/r/gnoswap/pool/v1"

# Fund admin with ugnot for gas and deposits
gnokey maketx send -send 10000000000ugnot -to $test1_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/scenario/upgrade/implements/v3_valid/pool -pkgpath gno.land/r/gnoswap/pool/v3_valid -gas-fee 1000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/scenario/upgrade/implements/security/attempt_store_writer -pkgpath gno.land/r/gnoswap/pool/attempt_store_writer -gas-fee 1000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1


# Upgrade to the permission probe implementation to capture store access
gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func UpgradeImpl -args gno.land/r/gnoswap/pool/attempt_store_writer -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
# stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetImplementationPackagePath()"
# stdout "gno.land/r/gnoswap/pool/attempt_store_writer"

# While v_permprobe is active it can write to the pool store
! gnokey maketx call -pkgpath gno.land/r/gnoswap/pool/attempt_store_writer -func AttemptStoreWrite -args 500000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
stderr 'write permission denied'

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetPoolCreationFee()"
# stdout 500000000

# Upgrade to v3_valid so v_permprobe loses write permission
gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func UpgradeImpl -args gno.land/r/gnoswap/pool/v3_valid -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
# stdout OK!

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetImplementationPackagePath()"
# stdout "gno.land/r/gnoswap/pool/v3_valid"

# Direct writes from the previously active package must now fail with write permission denied
! gnokey maketx call -pkgpath gno.land/r/gnoswap/pool/attempt_store_writer -func AttemptStoreWrite -args 600000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
stderr 'write permission denied'

# Pool creation fee remains unchanged because the write was blocked
gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetPoolCreationFee()"
# stdout 500000000
