loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/onbloc/usdc
loadpkg gno.land/r/onbloc/foo
loadpkg gno.land/r/onbloc/bar
loadpkg gno.land/r/onbloc/baz
loadpkg gno.land/r/onbloc/qux
loadpkg gno.land/r/onbloc/obl

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission
loadpkg gno.land/r/gnoswap/protocol_fee

loadpkg gno.land/r/gnoswap/pool
loadpkg gno.land/r/gnoswap/position
loadpkg gno.land/r/gnoswap/staker

loadpkg gno.land/r/gnoswap/protocol_fee/v1
loadpkg gno.land/r/gnoswap/pool/v1
loadpkg gno.land/r/gnoswap/position/v1
loadpkg gno.land/r/gnoswap/staker/v1

adduserfrom gns_admin 'mnemonic here'

adduser gnoswap
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $gnoswap_user_addr

adduser test_admin
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $test_admin_user_addr

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

adduser gnoswap_pool
patchpkg "g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v" $gnoswap_pool_user_addr

adduser gnoswap_router
patchpkg "g1vc883gshu5z7ytk5cdynhc8c2dh67pdp4cszkp" $gnoswap_router_user_addr

## start a new node
gnoland start 

gnokey maketx addpkg -pkgdir $WORK -pkgpath gno.land/r/swap_wrapper -gas-fee 100000ugnot -gas-wanted 15000000 -broadcast -chainid=tendermint_test test1
stdout OK!

### Send wugnot to neccessary accounts
gnokey maketx send -send 10000000000ugnot -to $gns_admin_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

### Transfer Bar tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
# gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $test_admin_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Transfer Foo tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Approve test tokens to pool address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Approve test tokens to staker address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Create Pool (BAR:FOO:500)
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func CreatePool -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 500 -args 79228162514264337593543950337 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.ExistsPoolPath(\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500\")"
stdout true

### Mint position
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func Mint -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 500 -args -60 -args 60 -args "5000000" -args "5000000" -args "1" -args "1" -args 9999999999 -args $gns_admin_user_addr -args $gns_admin_user_addr -args "" -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
stdout 1
stdout "1669251248"
stdout "5000000"
stdout OK!
stdout 'GAS USED:   8[0-9]{7}'
stdout 'STORAGE DELTA:  5[0-9]{4} bytes'
stdout 'TOTAL TX COST:  1[0-9]{7}ugnot'
stdout '{\"type\":\"Mint\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"tickLower\",\"value\":\"\-60\"},{\"key\":\"tickUpper\",\"value\":\"60\"},{\"key\":\"poolPath\",\"value\":\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500\"},{\"key\":\"mintTo\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"caller\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"lpPositionId\",\"value\":\"1\"},{\"key\":\"liquidity\",\"value\":\"1669251248\"},{\"key\":\"amount0\",\"value\":\"5000000\"},{\"key\":\"amount1\",\"value\":\"5000000\"},{\"key\":\"sqrtPriceX96\",\"value\":\"79228162514264337593543950337\"},{\"key\":\"token0Balance\",\"value\":\"5000000\"},{\"key\":\"token1Balance\",\"value\":\"5000000\"},{\"key\":\"tickCumulative\",\"value\":\"0\"},{\"key\":\"liquidityCumulative\",\"value\":\"0\"},{\"key\":\"secondsPerLiquidityCumulativeX128\",\"value\":\"0\"},'
gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPosition(1)"
stdout true


### Execute Swap
gnokey maketx call -pkgpath gno.land/r/swap_wrapper -func WrappedSwap -args "gno.land/r/onbloc/bar" -args gno.land/r/onbloc/foo -args 500 -args $gns_admin_user_addr -args false -args "20000000" -args "79228162514264337593543950338" -args $gns_admin_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout "0"
stdout "2"
stdout 'GAS USED:   5[0-9]{7}'
stdout 'STORAGE DELTA:  18 bytes'
stdout 'TOTAL TX COST:  10[0-9]{7}ugnot'
stdout '{\"type\":"Swap\",'

### Collect fees before reposition
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func CollectFee -args 1 -args false -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout 1
stdout "0"
stdout "gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500"
stdout OK!
stdout 'GAS USED:   4[0-9]{7}'
stdout 'STORAGE DELTA:  4359 bytes'
stdout 'TOTAL TX COST:  10[0-9]{7}ugnot'
stdout '{\"type\":\"CollectSwapFee\"'
stdout '{\"key\":\"lpPositionId\",\"value\":\"1\"},{\"key\":\"feeAmount0\",\"value\":\"0\"},{\"key\":\"feeAmount1\",\"value\":\"0\"},{\"key\":\"poolPath\",\"value\":\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500\"}'

### Decrease liquidity to clearing the position
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func DecreaseLiquidity -args 1 -args "1669251248" -args "0" -args "0" -args 9999999999 -args false -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout 1
stdout "1669251248"
stdout "0"
stdout "4999999"
stdout "gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500"
stdout OK!
stdout 'GAS USED:   (6|7)[0-9]{7}'
stdout 'STORAGE DELTA:  -1[0-9]{4} bytes'
stdout 'TOTAL TX COST:  9[0-9]{7}ugnot'
stdout '{\"type\":\"DecreaseLiquidity\"'
stdout '{\"key\":\"lpPositionId\",\"value\":\"1\"},{\"key\":\"poolPath\",\"value\":\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500\"},{\"key\":\"decreasedLiquidity\",\"value\":\"1669251248\"},{\"key\":\"feeAmount0\",\"value\":\"0\"},{\"key\":\"feeAmount1\",\"value\":\"0\"},{\"key\":\"amount0\",\"value\":\"4999999\"},{\"key\":\"amount1\",\"value\":\"4999999\"},{\"key\":\"unwrapResult\",\"value\":\"false\"},{\"key\":\"sqrtPriceX96\",\"value\":\"79228162514264337593543950338\"},{\"key\":\"positionLiquidity\",\"value\":\"0\"},{\"key\":\"token0Balance\",\"value\":\"1\"},{\"key\":\"token1Balance\",\"value\":\"1\"},{\"key\":\"tickCumulative\",\"value\":\"0\"},{\"key\":\"liquidityCumulative\",\"value\":\"1669251248\"},{\"key\":\"secondsPerLiquidityCumulativeX128\",\"value\":\"203853294900120669829431577235\"},'

gnokey query vm/qeval --data "gno.land/r/gnoswap/position.GetPosition(1)"
stdout true

### Repositioning to new range
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func Reposition -args 1 -args 9000 -args 13000 -args "50000000" -args "50000000" -args "0" -args "0" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout 1
stdout "432601712"
stdout 9000
stdout 13000
stdout "50000000"
stdout "0"
stdout OK!
stdout 'GAS USED:   5[0-9]{7}'
stdout 'STORAGE DELTA:  3[0-9]{4} bytes'
stdout 'TOTAL TX COST:  10[0-9]{7}ugnot'
stdout '\"type\":\"Reposition\"'
stdout '{\"key\":\"prevAddr\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"lpPositionId\",\"value\":\"1\"},{\"key\":\"tickLower\",\"value\":\"9000\"},{\"key\":\"tickUpper\",\"value\":\"13000\"},{\"key\":\"liquidity\",\"value\":\"432601712\"},{\"key\":\"amount0\",\"value\":\"50000000\"},{\"key\":\"amount1\",\"value\":\"0\"},{\"key\":\"prevTickLower\",\"value\":\"\-60\"},{\"key\":\"prevTickUpper\",\"value\":\"60\"},{\"key\":\"poolPath\",\"value\":\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:500\"},{\"key\":\"sqrtPriceX96\",\"value\":\"79228162514264337593543950338\"},{\"key\":\"positionLiquidity\",\"value\":\"432601712\"},{\"key\":\"token0Balance\",\"value\":\"50000001\"},{\"key\":\"token1Balance\",\"value\":\"1\"},{\"key\":\"tickCumulative\",\"value\":\"0\"},{\"key\":\"liquidityCumulative\",\"value\":\"1669251248\"},{\"key\":\"secondsPerLiquidityCumulativeX128\",\"value\":\"203853294900120669829431577235\"}'


-- gnomod.toml --
module = "gno.land/r/swap_wrapper"
gno = "0.9"
-- callback_mock.gno --
package swap_wrapper

import (
	"gno.land/r/gnoswap/pool"
)

func WrappedSwap(
    cur realm,
    token0Path string,
    token1Path string,
    fee uint32,
    recipient address,
    zeroForOne bool,
    amountSpecified string,
    sqrtPriceLimitX96 string,
    payer address,
) (string, string) {
    return pool.Swap(
        cross,
        token0Path,
        token1Path,
        fee,
        recipient,
        zeroForOne,
        amountSpecified,
        sqrtPriceLimitX96,
        payer,
        func(cur realm, token0Path, token1Path string) error {
            return nil
        },
    )
}
