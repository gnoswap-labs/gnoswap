loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/onbloc/usdc
loadpkg gno.land/r/onbloc/foo
loadpkg gno.land/r/onbloc/bar
loadpkg gno.land/r/onbloc/baz
loadpkg gno.land/r/onbloc/qux
loadpkg gno.land/r/onbloc/obl

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission
loadpkg gno.land/r/gnoswap/protocol_fee

loadpkg gno.land/r/gnoswap/pool
loadpkg gno.land/r/gnoswap/position
loadpkg gno.land/r/gnoswap/staker

loadpkg gno.land/r/gnoswap/protocol_fee/v1
loadpkg gno.land/r/gnoswap/pool/v1
loadpkg gno.land/r/gnoswap/position/v1
loadpkg gno.land/r/gnoswap/staker/v1

adduser test_admin
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $test_admin_user_addr

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

gnoland start 

# Transfer Bar tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" test1
stdout 'OK!'
stdout 'GAS USED:   4[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Transfer\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/bar\.BAR\"\},\{\"key\":\"from\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"1000000000\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/bar\"\}\]'

gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   4[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Transfer\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/bar\.BAR\"\},\{\"key\":\"from\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"100000000\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/bar\"\}\]'

# Transfer Foo tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" test1
stdout 'OK!'
stdout 'GAS USED:   4[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Transfer\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/foo\.FOO\"\},\{\"key\":\"from\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"1000000000\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/foo\"\}\]'

gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   4[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Transfer\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/foo\.FOO\"\},\{\"key\":\"from\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"100000000\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/foo\"\}\]'

# Approve test tokens to pool address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{6}'
stdout 'STORAGE DELTA:  1[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/bar\.BAR\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"spender\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"9223372036854775806\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/bar\"\}\]'

gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{6}'
stdout 'STORAGE DELTA:  1[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/foo\.FOO\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"spender\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"9223372036854775806\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/foo\"\}\]'

# Approve test tokens to staker address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/bar\.BAR\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"spender\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"9223372036854775806\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/bar\"\}\]'

gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{6}'
stdout 'STORAGE DELTA:  2[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/onbloc/foo\.FOO\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"spender\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"9223372036854775806\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/onbloc/foo\"\}\]'

# Create Pool (BAR:FOO:3000)
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 'OK!'
stdout 'GAS USED:   4[0-9]{6}'
stdout 'STORAGE DELTA:  1[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/gnoswap/gns\.GNS\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"spender\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"9223372036854775806\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/gnoswap/gns\"\}\]'

gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func CreatePool -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 3000 -args 79228162514264337593543950337 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{7}'
stdout 'STORAGE DELTA:  2[0-9]{4} bytes'
stdout 'TOTAL TX COST:  1[0-9]{7}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Transfer\",\"attrs\":\[\{\"key\":\"token\",\"value\":\"gno\.land/r/gnoswap/gns\.GNS\"\},\{\"key\":\"from\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"value\",\"value\":\"100000000\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc20\"\},\{\"type\":\"PoolCreationFee\",\"attrs\":\[\{\"key\":\"prevAddr\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"prevRealm\",\"value\":\"\"\},\{\"key\":\"poolPath\",\"value\":\"gno\.land/r/onbloc/bar:gno\.land/r/onbloc/foo:3000\"\},\{\"key\":\"feeTokenPath\",\"value\":\"gno\.land/r/gnoswap/gns\"\},\{\"key\":\"feeAmount\",\"value\":\"100000000\"\}\],\"pkg_path\":\"gno\.land/r/gnoswap/pool/v1\"\},\{\"type\":\"CreatePool\",\"attrs\":\[\{\"key\":\"prevAddr\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"prevRealm\",\"value\":\"\"\},\{\"key\":\"token0Path\",\"value\":\"gno\.land/r/onbloc/bar\"\},\{\"key\":\"token1Path\",\"value\":\"gno\.land/r/onbloc/foo\"\},\{\"key\":\"fee\",\"value\":\"3000\"\},\{\"key\":\"sqrtPriceX96\",\"value\":\"79228162514264337593543950337\"\},\{\"key\":\"poolPath\",\"value\":\"gno\.land/r/onbloc/bar:gno\.land/r/onbloc/foo:3000\"\},\{\"key\":\"tick\",\"value\":\"0\"\},\{\"key\":\"tickSpacing\",\"value\":\"60\"\}\],\"pkg_path\":\"gno\.land/r/gnoswap/pool/v1\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/gnoswap/gns\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/gnoswap/pool\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/gnoswap/protocol_fee\"\}\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.ExistsPoolPath(\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000\")"
stdout 'height: 0'
stdout 'data: \(true bool\)'

# Mint position
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func Mint -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 3000 -args -60 -args 60 -args "5000000" -args "5000000" -args "1" -args "1" -args 9999999999 -args $test1_user_addr -args $test1_user_addr -args "" -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   8[0-9]{7}'
stdout 'STORAGE DELTA:  5[0-9]{4} bytes'
stdout 'TOTAL TX COST:  1[0-9]{7}ugnot'

# Setup internal incentive pool
gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func SetPoolTier -args "gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000" -args 1 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{7}'
stdout 'STORAGE DELTA:  2[0-9]{4} bytes'
stdout 'TOTAL TX COST:  1[0-9]{7}ugnot'

gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.GetPoolTier(\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000\")"
stdout 'height: 0'
stdout 'data: \(1 uint64\)'

# Stake position
gnokey maketx call -pkgpath gno.land/r/gnoswap/gnft -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 1 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   3[0-9]{6}'
stdout 'STORAGE DELTA:  1[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{7}ugnot'
stdout 'EVENTS:     \[\{\"type\":\"Approval\",\"attrs\":\[\{\"key\":\"slug\",\"value\":\"GNFT\"\},\{\"key\":\"owner\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"to\",\"value\":\"g1[0-9a-z]{38}\"\},\{\"key\":\"tokenId\",\"value\":\"1\"\}\],\"pkg_path\":\"gno\.land/p/demo/tokens/grc721\"\},\{\"bytes_delta\":[0-9]+,\"fee_delta\":\{\"denom\":\"ugnot\",\"amount\":[0-9]+\},\"pkg_path\":\"gno\.land/r/gnoswap/gnft\"\}\]'

gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func StakeToken -args 1 -args "" -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   [0-9]{8}'
stdout '\[{\"type\":\"Transfer\",\"attrs\":\[{\"key\":\"slug\",\"value\":\"GNFT\"},{\"key\":\"from\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"to\",\"value\":\"g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3\"},{\"key\":\"tokenId\",\"value\":\"1\"}\],\"pkg_path\":\"gno.land/p/demo/tokens/grc721\"},{\"type\":\"StakeToken\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"positionId\",\"value\":\"1\"},{\"key\":\"poolPath\",\"value\":\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000\"},{\"key\":\"liquidity\",\"value\":\"1669251248\"},{\"key\":\"positionUpperTick\",\"value\":\"60\"},{\"key\":\"positionLowerTick\",\"value\":\"-60\"},{\"key\":\"currentTick\",\"value\":\"0\"},{\"key\":\"isInRange\",\"value\":\"true\"},{\"key\":\"referrer\",\"value\":\"\"},{\"key\":\"amount0\",\"value\":\"4999999\"},{\"key\":\"amount1\",\"value\":\"4999999\"}\],\"pkg_path\":\"gno.land/r/gnoswap/staker/v1\"}.*\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.IsStaked(1)"
stdout true

# Ownership of GNFT must be recognized as belonging to the staker.
gnokey query vm/qeval --data "gno.land/r/gnoswap/gnft.OwnerOf(\"1\")"
stdout '\"g1[0-9a-z]{38}\"'

gnokey query vm/qeval --data "gno.land/r/gnoswap/common.BalanceOf(\"gno.land/r/onbloc/bar\", \"g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v\")"
stdout 5000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/common.BalanceOf(\"gno.land/r/onbloc/foo\", \"g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v\")"
stdout 5000000

# Unstake position
gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func UnStakeToken -args 1 -args false -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test test1
stdout 'OK!'
stdout 'GAS USED:   (5|6)[0-9]{7}'
stdout 'STORAGE DELTA:  (-)*(5|6)[0-9]{3} bytes'
stdout 'TOTAL TX COST:  [0-9]+ugnot'

gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.IsStaked(1)"
stdout 'false'

# Check the ownership of GNFT
# The original owner's address must be returned, not the staker's address.
gnokey query vm/qeval --data "gno.land/r/gnoswap/gnft.OwnerOf(\"1\")"
stdout "g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5"
