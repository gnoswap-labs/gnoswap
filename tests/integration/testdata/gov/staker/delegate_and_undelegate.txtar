loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission

loadpkg gno.land/r/gnoswap/protocol_fee
loadpkg gno.land/r/gnoswap/protocol_fee/v1

loadpkg gno.land/r/gnoswap/gov/staker
loadpkg gno.land/r/gnoswap/gov/staker/v1

loadpkg gno.land/r/gnoswap/gov/governance
loadpkg gno.land/r/gnoswap/gov/governance/v1

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

adduser user2
patchpkg "g1wfj5getvv4nkzar9ta047h6lta047h6lycyuqt" $user2_user_addr

gnoland start 

# Send wugnot to neccessary accounts
gnokey maketx send -send 10000000000ugnot -to $test1_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

# Send wugnot to neccessary address
gnokey maketx send -send 500000000ugnot -to $user1_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1

# Transfer 1_000_000_000 GNS
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1

gnokey query vm/qeval --data "gno.land/r/gnoswap/gns.BalanceOf(\"$test1_user_addr\")"
stdout 99999900000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/xgns.BalanceOf(\"$test1_user_addr\")"
stdout 0

# delegate GNS from admin to user1
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9 -args 1000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/staker -func Delegate -args $user1_user_addr -args 1000000 -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 1000000
stdout 'GAS USED:   2[0-9]{7}'
stdout 'STORAGE DELTA:  1[0-9]{4} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[{\"type\":\"TransferProtocolFee\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9\"},{\"key\":\"prevRealm\",\"value\":\"gno.land/r/gnoswap/gov/staker\"},{\"key\":\"toDevOps\",\"value\":\"\"},{\"key\":\"toGovStaker\",\"value\":\"\"}\],\"pkg_path\":\"gno.land/r/gnoswap/protocol_fee/v1\"},{\"type\":\"Transfer\",\"attrs\":\[{\"key\":\"token\",\"value\":\"gno.land/r/gnoswap/gns.GNS\"},{\"key\":\"from\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"to\",\"value\":\"g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9\"},{\"key\":\"value\",\"value\":\"1000000\"}\],\"pkg_path\":\"gno.land/p/demo/tokens/grc20\"},{\"type\":\"Transfer\",\"attrs\":\[{\"key\":\"token\",\"value\":\"gno.land/r/gnoswap/gov/xgns.xGNS\"},{\"key\":\"from\",\"value\":\"\"},{\"key\":\"to\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"value\",\"value\":\"1000000\"}\],\"pkg_path\":\"gno.land/p/demo/tokens/grc20\"}.*\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/gns.BalanceOf(\"$test1_user_addr\")"
stdout 99999899000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/xgns.BalanceOf(\"$test1_user_addr\")"
stdout 1000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/gns.BalanceOf(\"$user1_user_addr\")"
stdout 1000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/xgns.BalanceOf(\"$user1_user_addr\")"
stdout 0

# undelegate from user1
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/staker -func Undelegate -args $user1_user_addr -args 1000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 1000000
stdout 'GAS USED:   2[0-9]{7}'
stdout 'STORAGE DELTA:  1[0-9]{3} bytes'
stdout 'TOTAL TX COST:  1[0-9]{8}ugnot'
stdout 'EVENTS:     \[{\"type\":\"TransferProtocolFee\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9\"},{\"key\":\"prevRealm\",\"value\":\"gno.land/r/gnoswap/gov/staker\"},{\"key\":\"toDevOps\",\"value\":\"\"},{\"key\":\"toGovStaker\",\"value\":\"\"}\],\"pkg_path\":\"gno.land/r/gnoswap/protocol_fee/v1\"},{\"type\":\"Undelegate\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"from\",\"value\":\"g1jg8mtutu9khhfwc4nxmuhcpftf0pajdhfvsqf5\"},{\"key\":\"to\",\"value\":\"g1[a-z0-9]+\"},{\"key\":\"amount\",\"value\":\"1000000\"}\],\"pkg_path\":\"gno.land/r/gnoswap/gov/staker/v1\"}.*\]'

gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/staker -func CollectUndelegatedGns -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" test1
stdout 0
stdout 'GAS USED:   1[0-9]{7}'
stdout 'EVENTS:     \[\]'
