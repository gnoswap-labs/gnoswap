loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

loadpkg gno.land/r/onbloc/usdc
loadpkg gno.land/r/onbloc/foo
loadpkg gno.land/r/onbloc/bar
loadpkg gno.land/r/onbloc/baz
loadpkg gno.land/r/onbloc/qux
loadpkg gno.land/r/onbloc/obl

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/p/gnoswap/uint256
loadpkg gno.land/p/gnoswap/int256
loadpkg gno.land/p/gnoswap/gnsmath
loadpkg gno.land/p/gnoswap/store
loadpkg gno.land/p/gnoswap/version_manager

loadpkg gno.land/r/gnoswap/access
loadpkg gno.land/r/gnoswap/rbac
loadpkg gno.land/r/gnoswap/halt
loadpkg gno.land/r/gnoswap/common
loadpkg gno.land/r/gnoswap/referral

loadpkg gno.land/r/gnoswap/gns
loadpkg gno.land/r/gnoswap/gnft
loadpkg gno.land/r/gnoswap/gov/xgns
loadpkg gno.land/r/gnoswap/emission
loadpkg gno.land/r/gnoswap/protocol_fee

loadpkg gno.land/r/gnoswap/pool
loadpkg gno.land/r/gnoswap/position
loadpkg gno.land/r/gnoswap/router
loadpkg gno.land/r/gnoswap/staker
loadpkg gno.land/r/gnoswap/gov/governance
loadpkg gno.land/r/gnoswap/gov/staker
loadpkg gno.land/r/gnoswap/launchpad

loadpkg gno.land/r/gnoswap/pool/v1
loadpkg gno.land/r/gnoswap/position/v1
loadpkg gno.land/r/gnoswap/router/v1
loadpkg gno.land/r/gnoswap/staker/v1
loadpkg gno.land/r/gnoswap/gov/governance/v1
loadpkg gno.land/r/gnoswap/gov/staker/v1
loadpkg gno.land/r/gnoswap/launchpad/v1

adduserfrom gns_admin 'source bonus chronic canvas draft south burst lottery vacant surface solve popular case indicate oppose farm nothing bullet exhibit title speed wink action roast'

adduser gnoswap
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $gnoswap_user_addr

adduser test_admin
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $test_admin_user_addr

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

adduser gnoswap_pool
patchpkg "g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v" $gnoswap_pool_user_addr

adduser gnoswap_router
patchpkg "g1vc883gshu5z7ytk5cdynhc8c2dh67pdp4cszkp" $gnoswap_router_user_addr

## start a new node
gnoland start 


### Send wugnot to neccessary accounts
gnokey maketx send -send 10000000000ugnot -to $gns_admin_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

### Send wugnot to neccessary address
gnokey maketx send -send 100000000ugnot -to $test_admin_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
gnokey maketx send -send 500000000ugnot -to $user1_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
gnokey maketx send -send 500000000ugnot -to $test_admin_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1

### Transfer 1_000_000_000 GNS
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $test_admin_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Approve GNS to gov/staker contract address
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/staker -func Delegate -args $gns_admin_user_addr -args 1000000000 -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1em9s40nfrwd2aqn9ypjv7d9x9z9c8uk5uxrza9 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/staker -func Delegate -args $gnoswap_user_addr -args 1000000000 -args "" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Create Text Proposal
### reconfigure governance with votingWeightSmoothingDuration set to 0 to immediately count delegations
### and votingPeriod set to 1 for quick testing
### Set executionDelay to 0 so executable proposals can run immediately in tests.
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/governance -func Reconfigure -args 0 -args 1 -args 0 -args 50 -args 0 -args 0 -args 2592000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Check GNS balance before proposal
gnokey query vm/qeval --data "gno.land/r/gnoswap/gns.BalanceOf(\"$gns_admin_user_addr\")"

### Check xGNS balance (voting power)
gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/xgns.BalanceOf(\"$gns_admin_user_addr\")"

### Wait for a few blocks to ensure the reconfiguration is processed
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/governance -func ProposeParameterChange -args "poolcreationfee" -args "set" -args 1 -args "gno.land/r/gnoswap/pool*EXE*SetPoolCreationFee*EXE*0" -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout 'GAS USED:   2[0-9]{7}'
stdout 'STORAGE DELTA:  1[0-9]{4} bytes'
stdout 'TOTAL TX COST:  10[0-9]{7}ugnot'
stdout 'EVENTS:     \[{\"type\":\"ProposeParameterChange\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"title\",\"value\":\"poolcreationfee\"},{\"key\":\"description\",\"value\":\"set\"},{\"key\":\"numToExecute\",\"value\":\"1\"},{\"key\":\"executions\",\"value\":\"gno.land/r/gnoswap/pool\*EXE\*SetPoolCreationFee\*EXE\*0\"},{\"key\":\"proposalId\",\"value\":\"1\"},{\"key\":\"quorumAmount\",\"value\":\"[0-9]+\"},{\"key\":\"maxVotingWeight\",\"value\":\"[0-9]+\"},{\"key\":\"configVersion\",\"value\":\"[0-9]+\"},{\"key\":\"createdAt\",\"value\":\"[0-9]+\"}\],\"pkg_path\":\"gno.land/r/gnoswap/gov/governance/v1\"},.*,\"pkg_path\":\"gno.land/r/gnoswap/gov/governance\"}\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/governance.GetTitleByProposalId(1)"
stdout '"poolcreationfee"'

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/governance.GetDescriptionByProposalId(1)"
stdout '"set"'

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/governance.GetExecutionStateByProposalId(1)"
stdout '"active"'

### Vote the proposal
gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/governance -func Vote -args 1 -args true -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout '"1000000000"'
stdout OK!
stdout 'GAS USED:   13[0-9]{6}'
stdout 'STORAGE DELTA:  12 bytes'
stdout 'TOTAL TX COST:  100001200ugnot'
stdout 'EVENTS:     \[{\"type\":\"Vote\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"prevPkgPath\",\"value\":\"\"},{\"key\":\"proposalId\",\"value\":\"1\"},{\"key\":\"voter\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"yes\",\"value\":\"yes\"},{\"key\":\"voteWeight\",\"value\":\"1000000000\"},{\"key\":\"voteYes\",\"value\":\"1000000000\"},{\"key\":\"voteNo\",\"value\":\"0\"}\],\"pkg_path\":\"gno.land/r/gnoswap/gov/governance/v1\"},{\"bytes_delta\":12,\"fee_delta\":{\"denom\":\"ugnot\",\"amount\":1200},\"pkg_path\":\"gno.land/r/gnoswap/gov/governance\"}\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/governance.GetExecutionStateByProposalId(1)"
stdout "active"

### Wait for a few blocks to ensure the reconfiguration is processed
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Transfer -args $user1_user_addr -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

gnokey query vm/qeval --data "gno.land/r/gnoswap/gov/governance.GetExecutionStateByProposalId(1)"
stdout "executable"

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetPoolCreationFee()"
stdout 100000000

gnokey maketx call -pkgpath gno.land/r/gnoswap/gov/governance -func Execute -args 1 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
stdout 1
stdout 'GAS USED:   2[0-9]{7}'
stdout 'STORAGE DELTA:  70 bytes'
stdout 'TOTAL TX COST:  100007000ugnot'
stdout 'EVENTS:     \[{\"type\":\"SetPoolCreationFee\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g1[a-z0-9]+\"},{\"key\":\"prevRealm\",\"value\":\"gno.land/r/gnoswap/gov/governance\"},{\"key\":\"prevFee\",\"value\":\"100000000\"},{\"key\":\"newFee\",\"value\":\"0\"}\],\"pkg_path\":\"gno.land/r/gnoswap/pool/v1\"},{\"type\":\"Execute\",\"attrs\":\[{\"key\":\"prevAddr\",\"value\":\"g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d\"},{\"key\":\"prevRealm\",\"value\":\"\"},{\"key\":\"proposalId\",\"value\":\"1\"}\],\"pkg_path\":\"gno.land/r/gnoswap/gov/governance/v1\"},.*,\"pkg_path\":\"gno.land/r/gnoswap/gov/governance\"}\]'

gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.GetPoolCreationFee()"
stdout 0
