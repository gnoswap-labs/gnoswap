loadpkg gno.land/p/nt/avl
loadpkg gno.land/p/nt/ufmt
loadpkg gno.land/p/onbloc/json
loadpkg gno.land/p/nt/ownable
loadpkg gno.land/p/demo/tokens/grc20
loadpkg gno.land/p/demo/tokens/grc721
loadpkg gno.land/r/demo/defi/foo20

loadpkg gno.land/r/sys/users
loadpkg gno.land/r/gnoland/wugnot
loadpkg gno.land/r/demo/defi/grc20reg

adduserfrom gns_admin 'mnemonic here'

adduser gnoswap
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $gnoswap_user_addr

adduser test_admin
patchpkg "g1lmvrrrr4er2us84h2732sru76c9zl2nvknha8c" $test_admin_user_addr

adduser user1
patchpkg "g16a7etgm9z2r653ucl36rj0l2yqcxgrz2jyegzx" $user1_user_addr

adduser gnoswap_pool
patchpkg "g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v" $gnoswap_pool_user_addr

adduser gnoswap_router
patchpkg "g1vc883gshu5z7ytk5cdynhc8c2dh67pdp4cszkp" $gnoswap_router_user_addr

## start a new node
gnoland start 


## deploy test-tokens

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/onbloc/foo -pkgpath gno.land/r/onbloc/foo -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/onbloc/bar -pkgpath gno.land/r/onbloc/bar -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1

## deploy packages

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/uint256 -pkgpath gno.land/p/gnoswap/uint256 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/int256 -pkgpath gno.land/p/gnoswap/int256 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/gnsmath -pkgpath gno.land/p/gnoswap/gnsmath -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/rbac -pkgpath gno.land/p/gnoswap/rbac -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/store -pkgpath gno.land/p/gnoswap/store -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/p/gnoswap/version_manager -pkgpath gno.land/p/gnoswap/version_manager -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1

## deploy realm

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/access -pkgpath gno.land/r/gnoswap/access -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/rbac -pkgpath gno.land/r/gnoswap/rbac -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/halt -pkgpath gno.land/r/gnoswap/halt -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/common -pkgpath gno.land/r/gnoswap/common -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/referral -pkgpath gno.land/r/gnoswap/referral -gas-fee 100000000ugnot -gas-wanted 3000000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/gns -pkgpath gno.land/r/gnoswap/gns -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/gnft -pkgpath gno.land/r/gnoswap/gnft -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/gov/xgns -pkgpath gno.land/r/gnoswap/gov/xgns -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/emission -pkgpath gno.land/r/gnoswap/emission -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/protocol_fee -pkgpath gno.land/r/gnoswap/protocol_fee -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/pool -pkgpath gno.land/r/gnoswap/pool -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/position -pkgpath gno.land/r/gnoswap/position -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/router -pkgpath gno.land/r/gnoswap/router -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/staker -pkgpath gno.land/r/gnoswap/staker -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1

## deploy versioned realm (v1)

gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/protocol_fee/v1 -pkgpath gno.land/r/gnoswap/protocol_fee/v1 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/pool/v1 -pkgpath gno.land/r/gnoswap/pool/v1 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/position/v1 -pkgpath gno.land/r/gnoswap/position/v1 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/router/v1 -pkgpath gno.land/r/gnoswap/router/v1 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1
gnokey maketx addpkg -pkgdir ../../../examples/gno.land/r/gnoswap/staker/v1 -pkgpath gno.land/r/gnoswap/staker/v1 -gas-fee 100000000ugnot -gas-wanted 100000000 -broadcast -chainid=tendermint_test test1


### Send wugnot to neccessary accounts
# gnokey maketx send -send 10000000000ugnot -to $gns_admin_user_addr -broadcast -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 test1

### Send wugnot to neccessary address
# gnokey maketx send -send 100000000ugnot -to $test_admin_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
# gnokey maketx send -send 500000000ugnot -to $user1_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1
# gnokey maketx send -send 500000000ugnot -to $test_admin_user_addr -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 100000000 -memo "" test1

### Transfer Bar tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
# gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Transfer -args $test_admin_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Transfer Foo tokens
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $test_admin_user_addr -args 1000000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "transfer 1_000_000_000 GNS" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $user1_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
# gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Transfer -args $test_admin_user_addr -args 100000000 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Approve test tokens to pool address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Approve test tokens to staker address
gnokey maketx call -pkgpath gno.land/r/onbloc/bar -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/onbloc/foo -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin

### Create Pool (BAR:FOO:3000)
gnokey maketx call -pkgpath gno.land/r/gnoswap/gns -func Approve -args g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v -args 9223372036854775806 -insecure-password-stdin=true -broadcast=true -chainid=tendermint_test -gas-fee 100000000ugnot -gas-wanted 1000000000 -memo "" gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/pool -func CreatePool -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 3000 -args 79228162514264337593543950337 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/pool.ExistsPoolPath(\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000\")"
stdout true

### Mint position
gnokey maketx call -pkgpath gno.land/r/gnoswap/position -func Mint -args "gno.land/r/onbloc/bar" -args "gno.land/r/onbloc/foo" -args 3000 -args -60 -args 60 -args "5000000" -args "5000000" -args "1" -args "1" -args 9999999999 -args $gns_admin_user_addr -args $gns_admin_user_addr -args "" -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
stdout 1
stdout "1669251248"
stdout "5000000"
stdout "5000000"

### Setup internal incentive pool
gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func SetPoolTier -args "gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000" -args 1 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.GetPoolTier(\"gno.land/r/onbloc/bar:gno.land/r/onbloc/foo:3000\")"
stdout 1

### Stake position
gnokey maketx call -pkgpath gno.land/r/gnoswap/gnft -func Approve -args g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3 -args 1 -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func StakeToken -args 1 -args "" -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.IsStaked(1)"
stdout true

### Ownership of GNFT must be recognized as belonging to the staker.
gnokey query vm/qeval --data "gno.land/r/gnoswap/gnft.OwnerOf(\"1\")"
stdout 'g1q6d4ns7zkr492rgl0pcgf5ajaf2dlz0nnptky3'

gnokey query vm/qeval --data "gno.land/r/gnoswap/common.BalanceOf(\"gno.land/r/onbloc/bar\", \"g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v\")"
stdout 5000000

gnokey query vm/qeval --data "gno.land/r/gnoswap/common.BalanceOf(\"gno.land/r/onbloc/foo\", \"g1dexaf6aqkkyr9yfy9d5up69lsn7ra80af34g5v\")"
stdout 5000000

### Unstake position
gnokey maketx call -pkgpath gno.land/r/gnoswap/staker -func UnStakeToken -args 1 -args false -gas-fee 10000000ugnot -gas-wanted 1000000000 -broadcast -chainid=tendermint_test gns_admin
gnokey query vm/qeval --data "gno.land/r/gnoswap/staker.IsStaked(1)"
stdout false

### Check the ownership of GNFT
### The original owner's address must be returned, not the staker's address.
gnokey query vm/qeval --data "gno.land/r/gnoswap/gnft.OwnerOf(\"1\")"
stdout 'g17290cwvmrapvp869xfnhhawa8sm9edpufzat7d'
