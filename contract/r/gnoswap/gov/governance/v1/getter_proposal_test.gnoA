package v1

import (
	"testing"

	"gno.land/p/nt/uassert"
)

// TestGetterProposal_All tests all getter functions related to Proposal using table-driven tests.
func TestGetterProposal_All(t *testing.T) {
	tests := []struct {
		name          string
		proposalId    int64
		proposal      *Proposal
		getterFunc    func(gv *governanceV1, id int64) any
		expectedValue any
		expectedPanic bool
		panicMessage  string
	}{
		{
			name:       "Get proposer address",
			proposalId: 1,
			proposal: &governance.Proposal{
				id:            1,
				proposer:      address("g1proposer"),
				configVersion: 42,
				status: &governance.ProposalStatus{
					voteStatus: &governance.ProposalVoteStatus{
						quorumAmount: 100,
						yea:          10,
						nay:          5,
					},
				},
				metadata: &ProposalMetadata{title: "TestTitle", description: "TestDesc"},
				data:     &ProposalData{proposalType: Text},
			},
			getterFunc:    func(gv *governanceV1, id int64) any {
				return gv.GetProposerByProposalId(id)
			},
			expectedValue: "g1proposer",
		},
		{
			name:       "Get proposal type",
			proposalId: 1,
			proposal: &Proposal{
				id:            1,
				proposer:      address("g1proposer"),
				configVersion: 42,
				status: &ProposalStatus{
					voteStatus: &ProposalVoteStatus{
						quorumAmount: 100,
						yea:          10,
						nay:          5,
					},
				},
				metadata: &ProposalMetadata{title: "TestTitle", description: "TestDesc"},
				data:     &ProposalData{proposalType: Text},
			},
			getterFunc:    func(gv *governanceV1, id int64) any {
				return gv.GetProposalTypeByProposalId(id)
			},
			expectedValue: "Text",
		},
		{
			name:          "Get non-existent proposal",
			proposalId:    999,
			proposal:      nil,
			getterFunc:    func(gv *governanceV1, id int64) any {
				return gv.GetProposerByProposalId(id)
			},
			expectedPanic: true,
			panicMessage:  "proposal(999) not found",
		},
	}

	for _, tc := range tests {
		t.Run(tc.name, func(t *testing.T) {
			// given
			gv := newMockGovernance()

			if tc.proposal != nil {
				gv.addProposal(tc.proposal)
			}

			// when & then
			if tc.expectedPanic {
				uassert.PanicsContains(t, tc.panicMessage, func() {
					tc.getterFunc(gv, tc.proposalId)
				})
			} else {
				result := tc.getterFunc(gv, tc.proposalId)
				uassert.Equal(t, result, tc.expectedValue)
			}
		})
	}
}
