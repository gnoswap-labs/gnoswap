// PKGPATH: gno.land/r/demo/main
package main

import (
	"gno.land/p/nt/ufmt"
	"gno.land/r/gnoswap/scenario/patterns/callback"
)

func main() {
	println("[SCENARIO] 1. Vulnerable Vault - Admin function called via callback")
	testVulnerableVault()
	println()

	println("[SCENARIO] 2. Secure Vault - CallbackMarker prevents admin function misuse")
	testSecureVault()
	println()
}

func testVulnerableVault() {
	callback.ResetVulnerableVault()

	ufmt.Printf("[INFO] initial balance: %d\n", callback.GetVulnerableBalance())
	ufmt.Printf("[INFO] initial admin key: %s\n", callback.GetAdminKey())

	callback.VulnerableWithdraw(100, callback.LegitimateCallback)
	ufmt.Printf("[EXPECTED] balance after legitimate callback should be %d\n", callback.GetVulnerableBalance())
	ufmt.Printf("[EXPECTED] admin key after legitimate callback should be %s\n", callback.GetAdminKey())

	callback.VulnerableWithdraw(50, callback.AdminResetBalance)
	ufmt.Printf("[EXPECTED] balance after admin function as callback should be %d\n", callback.GetVulnerableBalance())
	ufmt.Printf("[EXPECTED] admin key after admin function as callback should be %s\n", callback.GetAdminKey())
}

func testSecureVault() {
	callback.ResetSecureVault()

	ufmt.Printf("[INFO] initial balance: %d\n", callback.GetSecureBalance())
	ufmt.Printf("[INFO] initial admin key: %s\n", callback.GetSecureAdminKey())

	callback.SecureWithdraw(100, callback.SecureLegitimateCallback)
	ufmt.Printf("[EXPECTED] balance after legitimate callback should be %d\n", callback.GetSecureBalance())
	ufmt.Printf("[EXPECTED] admin key remains unchanged: %s\n", callback.GetSecureAdminKey())

	println("[INFO] SecureAdminResetBalance cannot be passed to SecureWithdraw")
	println("[INFO] Compiler rejects: signature mismatch")
	println("[INFO]   - Admin: func(cur realm, amount int64)")
	println("[INFO]   - Required: func(cur realm, amount int64, marker *CallbackMarker)")
}

// Output:
// [SCENARIO] 1. Vulnerable Vault - Admin function called via callback
// [INFO] initial balance: 1000
// [INFO] initial admin key: super_secret_key_12345
// [EXPECTED] balance after legitimate callback should be 900
// [EXPECTED] admin key after legitimate callback should be super_secret_key_12345
// [EXPECTED] balance after admin function as callback should be 999999
// [EXPECTED] admin key after admin function as callback should be ADMIN_RESET
//
// [SCENARIO] 2. Secure Vault - CallbackMarker prevents admin function misuse
// [INFO] initial balance: 1000
// [INFO] initial admin key: super_secret_key_12345
// [EXPECTED] balance after legitimate callback should be 900
// [EXPECTED] admin key remains unchanged: super_secret_key_12345
// [INFO] SecureAdminResetBalance cannot be passed to SecureWithdraw
// [INFO] Compiler rejects: signature mismatch
// [INFO]   - Admin: func(cur realm, amount int64)
// [INFO]   - Required: func(cur realm, amount int64, marker *CallbackMarker)
